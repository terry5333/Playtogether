<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PartyBox Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background: #020617; color: white; overflow-x: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .view { display: none; min-height: 100vh; flex-direction: column; padding: 24px; }
        .active { display: flex; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(12px); }
        .bingo-cell { aspect-ratio: 1; border: 1px solid #1e293b; border-radius: 12px; font-weight: 800; font-size: 22px; transition: all 0.2s ease; }
        .bingo-active { background: linear-gradient(135deg, #0891b2, #06b6d4); border-color: #22d3ee; box-shadow: 0 0 20px rgba(8,145,178,0.5); transform: scale(0.95); }
        .btn-host { background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid rgba(255,215,0,0.3); }
    </style>
</head>
<body>

    <div id="cfg-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-6 backdrop-blur-md">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm border border-cyan-500/30">
            <h3 id="cfg-title" class="text-2xl font-black mb-2 text-cyan-400">æ¨¡å¼è¨­å®š</h3>
            <p id="cfg-desc" class="text-xs text-slate-400 mb-8"></p>
            <div class="relative mb-8">
                <input id="cfg-input" type="number" class="w-full bg-slate-900/50 p-5 rounded-2xl text-center text-2xl font-bold border border-white/10 focus:border-cyan-500 outline-none transition-all">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold" id="cfg-unit"></span>
            </div>
            <button onclick="launchGame()" class="w-full bg-cyan-600 hover:bg-cyan-500 p-5 rounded-2xl font-black text-lg shadow-lg shadow-cyan-900/20 active:scale-95 transition">ç¢ºèªå•Ÿå‹•</button>
            <button onclick="document.getElementById('cfg-modal').classList.add('hidden')" class="mt-4 text-slate-500 text-sm font-bold">å–æ¶ˆ</button>
        </div>
    </div>

    <section id="v-room" class="view active">
        <div class="flex justify-between items-start mb-8">
            <div>
                <p class="text-[10px] font-black text-cyan-500 tracking-[0.2em] mb-1">ROOM ID</p>
                <h2 id="r-id" class="text-6xl font-black tracking-tighter">----</h2>
            </div>
            <div id="room-status-tag" class="glass px-4 py-2 rounded-full text-[10px] font-black text-emerald-400 border border-emerald-500/20 shadow-lg shadow-emerald-900/10">ç­‰å¾…ç©å®¶...</div>
        </div>

        <div class="mb-4 flex items-center gap-2">
            <span class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></span>
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Player List</span>
        </div>
        
        <div id="player-list" class="space-y-3 flex-1 overflow-y-auto pr-2">
            </div>

        <div id="host-controls" class="hidden mt-8 p-6 glass rounded-[2rem] border-t border-white/10 bg-gradient-to-b from-white/5 to-transparent">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-1 h-4 bg-yellow-500 rounded-full"></div>
                <p class="text-[10px] text-yellow-500 font-black uppercase tracking-widest">Host Command Center</p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="socket.emit('host_setup_trigger','SPY')" class="btn-host p-5 rounded-3xl flex flex-col items-center gap-3 active:scale-95 transition">
                    <span class="text-4xl">ğŸ•µï¸</span>
                    <span class="text-[10px] font-black tracking-widest">èª°æ˜¯è‡¥åº•</span>
                </button>
                <button onclick="socket.emit('host_setup_trigger','BINGO')" class="btn-host p-5 rounded-3xl flex flex-col items-center gap-3 active:scale-95 transition">
                    <span class="text-4xl">ğŸ”¢</span>
                    <span class="text-[10px] font-black tracking-widest">BINGO</span>
                </button>
            </div>
        </div>
    </section>

    <section id="v-play" class="view">
        <div id="game-ui" class="flex-1 flex flex-col justify-center items-center">
            </div>
    </section>

    <script>
        const socket = io();
        let myUser = JSON.parse(localStorage.getItem('partyUser') || 'null');
        let currentPendingMode = '', bingoCount = 0;

        // åˆå§‹åŒ–æª¢æŸ¥
        if (!myUser) { location.href = '/'; } // è‹¥æ²’è³‡æ–™å›é¦–é ç™»å…¥
        
        function go(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- æˆ¿ä¸»è¨­å®šè¦–çª—æ§åˆ¶ ---
        socket.on('open_config_ui', (mode) => {
            currentPendingMode = mode;
            const modal = document.getElementById('cfg-modal');
            const input = document.getElementById('cfg-input');
            const desc = document.getElementById('cfg-desc');
            const title = document.getElementById('cfg-title');
            const unit = document.getElementById('cfg-unit');

            modal.classList.remove('hidden');
            if(mode === 'SPY') { 
                title.innerText="èª°æ˜¯è‡¥åº•"; desc.innerText="æ¯äººç™¼è¨€è¨è«–æ™‚é–“"; input.value=60; unit.innerText="ç§’";
            } else if(mode === 'BINGO') { 
                title.innerText="BINGO"; desc.innerText="å…ˆé”æˆå¹¾æ¢ç·šç²å‹"; input.value=3; unit.innerText="æ¢";
            }
        });

        function launchGame() {
            const val = document.getElementById('cfg-input').value;
            socket.emit('start_game_final', { mode: currentPendingMode, val: val });
            document.getElementById('cfg-modal').classList.add('hidden');
        }

        // --- éŠæˆ²æ¸²æŸ“é‚è¼¯ ---
        socket.on('game_init', (data) => {
            go('v-play');
            const container = document.getElementById('game-ui');
            if(data.type === 'BINGO') {
                bingoCount = 0;
                container.innerHTML = `
                    <div class="text-center mb-8">
                        <p class="text-cyan-400 font-black text-xs tracking-widest mb-2 uppercase">Bingo Setup</p>
                        <h3 class="text-2xl font-black">é»æ“Šæ ¼å­å¡«å…¥ 1-25</h3>
                    </div>
                    <div id="b-grid" class="grid grid-cols-5 gap-2 w-full max-w-sm aspect-square"></div>
                `;
                for(let i=0; i<25; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'bingo-cell glass flex items-center justify-center';
                    btn.onclick = () => {
                        if(btn.innerText) return;
                        bingoCount++;
                        btn.innerText = bingoCount;
                        btn.classList.add('bingo-active');
                        if(bingoCount === 25) {
                            btn.parentElement.innerHTML = '<div class="text-center animate-bounce"><p class="text-4xl mb-4">âœ…</p><p class="font-bold">å¡«è™Ÿå®Œæˆï¼Œç­‰å¾…é–‹æˆ°</p></div>';
                            socket.emit('bingo_ready');
                        }
                    };
                    document.getElementById('b-grid').appendChild(btn);
                }
            } else if(data.type === 'SPY') {
                container.innerHTML = `
                    <div class="text-center p-12 glass rounded-[3rem] border border-white/10">
                        <p class="text-slate-500 font-bold mb-4">ä½ çš„èº«ä»½ï¼š<span class="text-white">${data.role}</span></p>
                        <p class="text-[10px] text-cyan-500 tracking-widest mb-2 uppercase">Your Word</p>
                        <h1 class="text-7xl font-black text-white mb-10 tracking-tighter">${data.word}</h1>
                        <div id="timer" class="text-4xl font-mono text-red-500 bg-red-500/10 py-4 rounded-2xl border border-red-500/20">${data.timer}s</div>
                    </div>
                `;
                let s = data.timer;
                const t = setInterval(() => {
                    s--; document.getElementById('timer').innerText = s + 's';
                    if(s <= 0) { clearInterval(t); document.getElementById('timer').innerText = "æ™‚é–“åˆ°ï¼"; }
                }, 1000);
            }
        });

        // --- æˆ¿é–“æ•¸æ“šåŒæ­¥ ---
        socket.on('room_sync', (data) => {
            document.getElementById('r-id').innerText = data.room.id;
            
            // æ¸²æŸ“ç©å®¶åˆ—è¡¨
            const pList = document.getElementById('player-list');
            pList.innerHTML = data.room.players.map(p => `
                <div class="glass p-5 rounded-[1.5rem] flex justify-between items-center border border-white/5">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl">${p.avatar}</span>
                        <span class="font-bold">${p.username}</span>
                    </div>
                    ${p.pin === data.hostPin ? '<span class="text-[8px] bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded-md font-black">HOST</span>' : ''}
                </div>
            `).join('');

            // é‡è¦ï¼šåˆ¤æ–·æˆ¿ä¸»æ¬Šé™
            if (myUser && data.hostPin === myUser.pin) {
                document.getElementById('host-controls').classList.remove('hidden');
                document.getElementById('room-status-tag').innerText = "ä½ æ˜¯æˆ¿ä¸»";
                document.getElementById('room-status-tag').className = "glass px-4 py-2 rounded-full text-[10px] font-black text-yellow-400 border border-yellow-500/20 shadow-lg shadow-yellow-900/10";
            }
        });

        // é‡æ–°é€£æ¥æˆ–é‡æ–°åŠ å…¥æˆ¿é–“
        const rid = new URLSearchParams(window.location.search).get('rid');
        if (rid && myUser) {
            socket.emit('join_room', { roomId: rid, user: myUser });
            socket.emit('save_profile', myUser); // ç¢ºä¿å¾Œç«¯ memoryDB æœ‰è³‡æ–™
        }
    </script>
</body>
</html>
