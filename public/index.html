<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayTogether - Premium Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell-active { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .marked { background-color: #3b82f6 !important; color: white; border-color: #2563eb; transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">
    <div class="max-w-md mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight">BINGO!</h1>
            <p class="text-slate-500 mt-2">èˆ‡å¥½å‹å³æ™‚é€£ç·šå°æˆ°</p>
        </header>

        <div id="setup-panel" class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700">æˆ¿é–“ä»£ç¢¼</label>
                    <input type="text" id="roomInput" class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è¼¸å…¥è‡ªè¨‚ä»£ç¢¼">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">äººæ•¸ä¸Šé™</label>
                        <input type="number" id="maxPlayers" value="2" class="w-full mt-1 p-3 border rounded-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">å‹åˆ©é€£ç·šæ•¸</label>
                        <input type="number" id="winLines" value="5" class="w-full mt-1 p-3 border rounded-xl">
                    </div>
                </div>
                <button onclick="joinRoom()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-200">
                    å»ºç«‹ / åŠ å…¥æˆ¿é–“
                </button>
            </div>
        </div>

        <div id="game-panel" class="hidden">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-4">
                <div class="text-sm font-semibold">æˆ¿é–“: <span id="display-room" class="text-blue-600">--</span></div>
                <div id="line-badge" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm font-bold">é€£ç·š: 0 / 5</div>
            </div>
            
            <div id="bingoGrid" class="grid grid-cols-5 gap-2 bg-white p-4 rounded-2xl shadow-xl border-4 border-white">
                </div>
            
            <p id="player-status" class="text-center text-slate-400 text-sm mt-4">ç­‰å¾…å°æ‰‹åŠ å…¥...</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = "";
        let boardState = Array(25).fill(false);
        let numberToIdx = {};
        let targetLines = 5;

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value;
            const maxPlayers = document.getElementById('maxPlayers').value;
            const winLines = document.getElementById('winLines').value;
            
            if (!roomId) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼");
            
            targetLines = parseInt(winLines);
            socket.emit('join_room', { roomId, maxPlayers, winLines });
            
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('game-panel').classList.remove('hidden');
            document.getElementById('display-room').innerText = roomId;
            document.getElementById('line-badge').innerText = `é€£ç·š: 0 / ${targetLines}`;
            
            generateBingo();
        }

        function generateBingo() {
            const nums = Array.from({length: 25}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            const grid = document.getElementById('bingoGrid');
            grid.innerHTML = '';
            nums.forEach((num, idx) => {
                numberToIdx[num] = idx;
                const btn = document.createElement('button');
                btn.className = "cell aspect-square bg-slate-100 rounded-lg text-xl font-bold hover:bg-slate-200 transition-all border-b-4 border-slate-300 active:border-b-0 cell-active";
                btn.innerText = num;
                btn.id = `idx-${idx}`;
                btn.onclick = () => {
                    socket.emit('game_move', { roomId: document.getElementById('roomInput').value, number: num });
                    markNumber(num);
                };
                grid.appendChild(btn);
            });
        }

        function markNumber(num) {
            const idx = numberToIdx[num];
            if (idx !== undefined && !boardState[idx]) {
                boardState[idx] = true;
                const el = document.getElementById(`idx-${idx}`);
                el.classList.add('marked');
                el.disabled = true;
                checkWin();
            }
        }

        function checkWin() {
            let lines = 0;
            for (let i = 0; i < 5; i++) {
                if ([0,1,2,3,4].every(j => boardState[i*5 + j])) lines++; // æ©«
                if ([0,1,2,3,4].every(j => boardState[j*5 + i])) lines++; // è±
            }
            if ([0,6,12,18,24].every(i => boardState[i])) lines++;
            if ([4,8,12,16,20].every(i => boardState[i])) lines++;

            document.getElementById('line-badge').innerText = `é€£ç·š: ${lines} / ${targetLines}`;
            if (lines >= targetLines) alert("ğŸ‰ BINGO! ä½ è´äº†ï¼");
        }

        socket.on('room_update', (data) => {
            document.getElementById('player-status').innerText = `ç›®å‰äººæ•¸: ${data.currentPlayers} / ${data.maxPlayers}`;
            targetLines = data.winLines;
            document.getElementById('line-badge').innerText = `é€£ç·š: 0 / ${targetLines}`;
        });

        socket.on('receive_move', (data) => markNumber(data.number));
    </script>
</body>
</html>
