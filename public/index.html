<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PartyBox 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .hidden { display: none !important; }
        .card { border-radius: 2rem; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .mem-card { height: 70px; background: #f1f5f9; border-radius: 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; }
        .mem-card.flipped { background: white; border: 2px solid #e2e8f0; }
        .mem-card.matched { background: #dcfce7; opacity: 0.6; cursor: default; }
    </style>
</head>
<body class="bg-[#F2EBE1] min-h-screen flex items-center justify-center p-4">
    <div id="toast" class="fixed top-5 bg-black/80 text-white px-6 py-2 rounded-full opacity-0 transition-all z-50 pointer-events-none"></div>

    <section id="view-auth" class="card p-10 w-full max-w-sm space-y-6 text-center">
        <h1 class="text-4xl font-black text-blue-300">PartyBox</h1>
        <div class="flex justify-center gap-2" id="avatars">
            <button onclick="selAv('ğŸ¶')" class="text-2xl p-2 border-2 rounded-xl border-blue-400">ğŸ¶</button>
            <button onclick="selAv('ğŸ±')" class="text-2xl p-2 border-2 rounded-xl">ğŸ±</button>
            <button onclick="selAv('ğŸ¦Š')" class="text-2xl p-2 border-2 rounded-xl">ğŸ¦Š</button>
        </div>
        <input id="u" type="text" placeholder="å¸³è™Ÿ" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
        <input id="p" type="password" placeholder="å¯†ç¢¼" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
        <button onclick="auth()" class="w-full p-4 bg-blue-300 text-white font-bold rounded-2xl">é€²å…¥æ´¾å°</button>
    </section>

    <section id="view-lobby" class="hidden card p-8 w-full max-w-sm space-y-6">
        <div class="flex justify-between items-center bg-blue-50 p-4 rounded-3xl">
            <span id="my-info" class="font-bold text-blue-600">ğŸ¶ Name</span>
            <span id="my-score" class="bg-blue-400 text-white px-3 py-1 rounded-full text-xs font-bold">0 pt</span>
        </div>
        <div class="bg-gray-50 p-4 rounded-3xl text-sm">
            <h4 class="font-bold text-gray-400 mb-2">ğŸ† æ’è¡Œæ¦œ</h4>
            <div id="leaders" class="space-y-1"></div>
        </div>
        <div id="actions" class="space-y-2">
            <button onclick="socket.emit('create_room')" class="w-full p-4 bg-blue-400 text-white rounded-2xl font-bold">å‰µå»ºæˆ¿é–“</button>
            <div class="flex gap-2">
                <input id="rid" type="number" placeholder="æˆ¿è™Ÿ" class="w-2/3 p-4 bg-gray-100 rounded-2xl outline-none">
                <button onclick="join()" class="w-1/3 bg-gray-200 rounded-2xl font-bold">åŠ å…¥</button>
            </div>
        </div>
        <div id="wait" class="hidden text-center space-y-4">
            <h2 id="room-num" class="text-5xl font-black">----</h2>
            <div id="players" class="flex flex-wrap gap-2 justify-center"></div>
            <div id="host-zone" class="hidden pt-4 border-t space-y-2">
                <button onclick="socket.emit('host_setup_game',{type:'memory'})" class="w-full p-4 bg-blue-100 text-blue-500 rounded-2xl font-bold">ğŸ§  è¨˜æ†¶å¡ç‰Œ</button>
            </div>
        </div>
    </section>

    <section id="view-memory" class="hidden card p-6 w-full max-w-md text-center">
        <div id="mem-grid" class="grid grid-cols-4 gap-2"></div>
    </section>

    <script>
        const socket = io();
        let myUser = null, avatar = 'ğŸ¶';

        function v(id) { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function selAv(a) { avatar = a; document.querySelectorAll('#avatars button').forEach(b => b.classList.remove('border-blue-400')); event.target.classList.add('border-blue-400'); }
        function auth() { socket.emit('auth_action', { type: 'register', username: u.value, password: p.value, avatar }); }
        
        socket.on('auth_success', user => { 
            myUser = user; 
            document.getElementById('my-info').innerText = `${user.avatar} ${user.username}`;
            v('view-lobby'); 
        });

        socket.on('leaderboard_update', list => {
            document.getElementById('leaders').innerHTML = list.map((u, i) => `<div>${i+1}. ${u.avatar} ${u.username} - ${u.score}</div>`).join('');
            const me = list.find(u => u.username === myUser?.username);
            if(me) document.getElementById('my-score').innerText = me.score + " pt";
        });

        function join() { socket.emit('join_room', { roomId: rid.value, user: myUser }); }
        socket.on('room_created', d => socket.emit('join_room', { roomId: d.roomId, user: myUser }));
        socket.on('room_update', d => {
            v('view-lobby'); document.getElementById('actions').classList.add('hidden'); document.getElementById('wait').classList.remove('hidden');
            document.getElementById('room-num').innerText = d.roomId;
            document.getElementById('host-zone').classList.toggle('hidden', socket.id !== d.hostId);
            document.getElementById('players').innerHTML = d.players.map(p => `<div>${p.avatar}</div>`).join('');
        });

        socket.on('game_begin', d => {
            if(d.type === 'memory') {
                v('view-memory'); const g = document.getElementById('mem-grid'); g.innerHTML = '';
                for(let i=0; i<d.cardCount; i++) {
                    const c = document.createElement('div'); c.className = "mem-card"; 
                    c.onclick = () => socket.emit('memory_flip', i); c.dataset.idx = i; g.appendChild(c);
                }
            }
        });

        socket.on('memory_sync_flip', f => f.forEach(x => { const e = document.querySelector(`[data-idx="${x.idx}"]`); e.innerText = x.val; e.classList.add('flipped'); }));
        socket.on('memory_flip_back', () => document.querySelectorAll('.mem-card:not(.matched)').forEach(e => { e.innerText = ''; e.classList.remove('flipped'); }));
        socket.on('memory_match_success', m => m.forEach(i => document.querySelector(`[data-idx="${i}"]`).classList.add('matched')));
        socket.on('game_over', d => { alert("è´å®¶æ˜¯ " + d.winner); v('view-lobby'); });
        socket.on('force_leave', () => location.reload());
        socket.on('toast', m => { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); });
    </script>
</body>
</html>
