<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Party - Morandi Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©ä½é£½å’Œé…è‰² */
        body { background-color: #F2F0EB; color: #5F6368; } /* ç±³ç™½èƒŒæ™¯, æ·±ç°æ–‡å­— */
        .card { background-color: #FFFFFF; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); }
        .btn-blue { background-color: #A3B9C9; color: white; } /* ä½é£½å’Œè— */
        .btn-green { background-color: #B4C4B8; color: white; } /* ä½é£½å’Œç¶  */
        .btn-gray { background-color: #D1D1D1; color: white; } /* ä½é£½å’Œç° */
        .cell-empty { background-color: #F8F9FA; border: 1px solid #E9ECEF; }
        .cell-marked { background-color: #A3B9C9 !important; color: white; border: none; }
        .player-tag { background-color: #E9ECEF; color: #7F8C8D; border-radius: 8px; }
        .host-icon { color: #D4AF37; font-size: 10px; margin-left: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">
    
    <div class="w-full max-w-md card overflow-hidden border border-gray-100">
        <div class="p-6 text-center border-b border-gray-50">
            <h1 class="text-2xl font-light tracking-widest text-slate-400 uppercase">Bingo Together</h1>
            <div id="room-display" class="text-xs text-slate-300 mt-1 uppercase tracking-widest hidden">Room: --</div>
        </div>

        <div class="p-8">
            <div id="step-1" class="space-y-6">
                <div class="text-center space-y-2">
                    <p class="text-sm text-slate-400">è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±é–‹å§‹éŠæˆ²</p>
                    <input type="text" id="nameInp" class="w-full p-4 bg-gray-50 rounded-2xl outline-none text-center text-lg focus:ring-1 ring-blue-200 transition-all" placeholder="ç©å®¶åç¨±">
                </div>
                <button onclick="toLobby()" class="w-full btn-blue py-4 rounded-2xl font-medium shadow-sm hover:opacity-90 transition-all">é€²å…¥éŠæˆ²å¤§å»³</button>
            </div>

            <div id="step-2" class="hidden space-y-8">
                <section class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-300 uppercase tracking-widest">å‰µå»ºæ–°æˆ¿é–“</h3>
                    <input type="text" id="cRoomId" placeholder="è¨­å®šæˆ¿è™Ÿ" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-50 p-2 rounded-xl">
                            <label class="block text-[10px] text-slate-400 ml-1">äººæ•¸</label>
                            <input type="number" id="cMaxP" value="2" class="bg-transparent w-full text-center text-sm outline-none">
                        </div>
                        <div class="bg-gray-50 p-2 rounded-xl">
                            <label class="block text-[10px] text-slate-400 ml-1">å‹åˆ©ç·š</label>
                            <input type="number" id="cWinL" value="3" class="bg-transparent w-full text-center text-sm outline-none">
                        </div>
                    </div>
                    <button onclick="join(true)" class="w-full btn-blue py-3 rounded-xl text-sm font-medium">å»ºç«‹ä¸¦è¨­å®šè¦å‰‡</button>
                </section>

                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-gray-100"></div>
                    <span class="flex-shrink mx-4 text-gray-300 text-[10px]">æˆ–</span>
                    <div class="flex-grow border-t border-gray-100"></div>
                </div>

                <section class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-300 uppercase tracking-widest">åŠ å…¥å¥½å‹æˆ¿é–“</h3>
                    <input type="text" id="jRoomId" placeholder="è¼¸å…¥æˆ¿è™Ÿ" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none">
                    <button onclick="join(false)" class="w-full btn-green py-3 rounded-xl text-sm font-medium">ç«‹å³åŠ å…¥</button>
                </section>
            </div>

            <div id="step-3" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs font-bold text-slate-300 uppercase tracking-widest">ä½ˆç½®æ‚¨çš„ç›¤é¢</h3>
                    <span id="fill-hint" class="text-[10px] btn-blue px-2 py-1 rounded-full">å¡«å…¥: 1</span>
                </div>
                <div id="fillGrid" class="grid grid-cols-5 gap-2"></div>
                <button id="readyBtn" onclick="toGame()" disabled class="w-full mt-8 btn-gray py-4 rounded-2xl font-medium cursor-not-allowed">å¡«æ»¿å¾Œé€²å…¥å°æˆ°</button>
            </div>

            <div id="step-4" class="hidden">
                <div class="mb-6 space-y-2">
                    <div class="flex justify-between items-end">
                        <h3 class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">ç›®å‰ç©å®¶</h3>
                        <span id="win-goal" class="text-[10px] text-slate-400 underline decoration-blue-200">ç›®æ¨™: 3 ç·š</span>
                    </div>
                    <div id="player-list" class="flex flex-wrap gap-2 py-2">
                        </div>
                </div>

                <div id="gameGrid" class="grid grid-cols-5 gap-2 mb-6"></div>
                
                <div class="h-8 flex items-center justify-center">
                    <p id="log" class="text-xs text-slate-400 italic"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, curRoom, myLayout = Array(25).fill(null), fillCount = 1, boardState = Array(25).fill(false), winTarget = 3, isGameOver = false;

        const hideAll = () => ['step-1','step-2','step-3','step-4'].forEach(s => document.getElementById(s).classList.add('hidden'));
        
        function toLobby() {
            myName = document.getElementById('nameInp').value;
            if(!myName) return;
            hideAll();
            document.getElementById('step-2').classList.remove('hidden');
        }

        function join(isHost) {
            const rId = isHost ? document.getElementById('cRoomId').value : document.getElementById('jRoomId').value;
            if(!rId) return;
            curRoom = rId;
            document.getElementById('room-display').innerText = `Room: ${rId}`;
            document.getElementById('room-display').classList.remove('hidden');
            
            socket.emit('join_room', { 
                roomId: rId, 
                username: myName, 
                maxPlayers: document.getElementById('cMaxP').value, 
                winLines: document.getElementById('cWinL').value 
            });
            hideAll();
            initFill();
        }

        function initFill() {
            document.getElementById('step-3').classList.remove('hidden');
            const g = document.getElementById('fillGrid');
            g.innerHTML = '';
            for(let i=0; i<25; i++) {
                const b = document.createElement('button');
                b.className = "aspect-square cell-empty rounded-xl text-slate-300 font-medium hover:bg-gray-100 transition-colors";
                b.onclick = () => {
                    if(myLayout[i]) return;
                    myLayout[i] = fillCount;
                    b.innerText = fillCount;
                    b.className = "aspect-square bg-white border border-blue-100 rounded-xl text-blue-400 font-bold shadow-sm";
                    fillCount++;
                    if(fillCount <= 25) document.getElementById('fill-hint').innerText = `å¡«å…¥: ${fillCount}`;
                    else {
                        document.getElementById('fill-hint').innerText = `å®Œæˆ`;
                        document.getElementById('readyBtn').disabled = false;
                        document.getElementById('readyBtn').className = "w-full mt-8 btn-blue py-4 rounded-2xl font-medium shadow-md transition-all";
                    }
                };
                g.appendChild(b);
            }
        }

        function toGame() {
            hideAll();
            document.getElementById('step-4').classList.remove('hidden');
            const g = document.getElementById('gameGrid');
            g.innerHTML = '';
            myLayout.forEach((num, idx) => {
                const b = document.createElement('button');
                b.className = "aspect-square bg-white border border-gray-100 rounded-xl text-lg font-medium text-slate-500 hover:bg-gray-50 transition-all";
                b.innerText = num;
                b.id = `cell-${num}`;
                b.onclick = () => {
                    if(isGameOver) return;
                    socket.emit('game_move', { roomId: curRoom, number: num });
                    mark(num);
                };
                g.appendChild(b);
            });
        }

        function mark(num) {
            const btn = document.getElementById(`cell-${num}`);
            if(btn && !btn.disabled) {
                btn.disabled = true;
                btn.className = "aspect-square cell-marked rounded-xl text-lg font-bold shadow-inner opacity-80";
                const idxInLayout = myLayout.indexOf(num);
                boardState[idxInLayout] = true;
                check();
            }
        }

        function check() {
            let lines = 0;
            for(let i=0; i<5; i++) {
                if([0,1,2,3,4].every(j => boardState[i*5+j])) lines++;
                if([0,1,2,3,4].every(j => boardState[j*5+i])) lines++;
            }
            if([0,6,12,18,24].every(i => boardState[i])) lines++;
            if([4,8,12,16,20].every(i => boardState[i])) lines++;

            if(lines >= winTarget && !isGameOver) {
                socket.emit('player_win', { roomId: curRoom });
            }
        }

        socket.on('room_update', (data) => {
            if(data.players) {
                const pList = document.getElementById('player-list');
                pList.innerHTML = '';
                data.players.forEach(p => {
                    const span = document.createElement('span');
                    span.className = "player-tag px-3 py-1 text-[10px] flex items-center";
                    span.innerText = p.name;
                    if(p.id === data.host) span.innerHTML += ' <span class="host-icon">â˜…</span>';
                    pList.appendChild(span);
                });
            }
            if(data.winLines) {
                winTarget = data.winLines;
                document.getElementById('win-goal').innerText = `ç›®æ¨™: ${winTarget} ç·š`;
            }
        });

        socket.on('receive_move', (data) => {
            mark(data.number);
            document.getElementById('log').innerText = `${data.senderName} å–Šäº†æ•¸å­— ${data.number}`;
        });

        socket.on('game_over', (data) => {
            isGameOver = true;
            document.getElementById('log').innerText = `ğŸ† å„ªå‹è€…ï¼š${data.winner}`;
            document.getElementById('log').className = "text-sm font-bold text-blue-400 animate-pulse";
            alert(`éŠæˆ²çµæŸï¼æ­å–œ ${data.winner} ç²å¾—å‹åˆ©ï¼`);
        });

        socket.on('error_msg', (m) => alert(m));
    </script>
</body>
</html>
