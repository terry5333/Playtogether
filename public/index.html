<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PartyBox Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; overflow: hidden; }
        .view { display: none; min-height: 100vh; flex-direction: column; padding: 1.5rem; }
        .active { display: flex; }
        .glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .av-btn { border: 2px solid transparent; border-radius: 1rem; transition: 0.3s; }
        .av-active { border-color: #06b6d4; background: rgba(6, 182, 212, 0.2); }
    </style>
</head>
<body>

    <section id="v-pin" class="view active items-center justify-center">
        <h1 class="text-6xl font-black mb-10 italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">PartyBox</h1>
        <input id="i-pin" type="text" maxlength="4" placeholder="è¼¸å…¥ 4 ä½ PIN" class="w-full max-w-xs bg-white/5 p-5 rounded-3xl text-center text-4xl border border-white/10 outline-none focus:border-cyan-500 transition font-mono">
        <button onclick="checkPin()" class="w-full max-w-xs mt-6 bg-cyan-600 p-5 rounded-3xl font-bold text-xl active:scale-95 transition">é–‹å§‹</button>
    </section>

    <section id="v-setup" class="view items-center justify-center">
        <div class="w-full max-w-sm glass p-8 rounded-[2.5rem] text-center">
            <h2 class="text-2xl font-bold mb-8">è¨­å®šä½ çš„è§’è‰²</h2>
            <div class="grid grid-cols-4 gap-2 mb-8">
                <button onclick="selAv('ğŸ¶', this)" class="av-btn p-2 text-3xl av-active">ğŸ¶</button>
                <button onclick="selAv('ğŸ¦Š', this)" class="av-btn p-2 text-3xl">ğŸ¦Š</button>
                <button onclick="selAv('ğŸ·', this)" class="av-btn p-2 text-3xl">ğŸ·</button>
                <button onclick="selAv('ğŸµ', this)" class="av-btn p-2 text-3xl">ğŸµ</button>
            </div>
            <input id="i-name" type="text" placeholder="è¼¸å…¥æš±ç¨±" class="w-full bg-white/5 p-4 rounded-2xl text-center text-xl mb-8 outline-none border border-white/10">
            <button onclick="saveProfile()" class="w-full bg-white text-slate-900 p-4 rounded-2xl font-black text-lg">ç¢ºèªé€²å…¥</button>
        </div>
    </section>

    <section id="v-lobby" class="view">
        <div class="flex justify-between items-center mb-8">
            <div id="u-info" class="text-lg font-bold"></div>
            <div id="u-score" class="text-cyan-400 font-mono">0 pt</div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <button onclick="socket.emit('create_room')" class="glass p-8 rounded-3xl text-center border-t border-cyan-500/30">
                <div class="text-3xl mb-2">âœ¨</div><div class="font-bold">å»ºç«‹æˆ¿é–“</div>
            </button>
            <div class="glass p-4 rounded-3xl">
                <input id="i-rid" type="text" placeholder="æˆ¿è™Ÿ" class="w-full bg-white/5 p-2 rounded-xl text-center mb-2 outline-none">
                <button onclick="joinRoom()" class="w-full bg-blue-600 py-2 rounded-xl text-sm font-bold">åŠ å…¥</button>
            </div>
        </div>
        <div class="glass flex-1 rounded-3xl p-6">
            <h3 class="text-slate-500 text-xs font-bold uppercase mb-4 tracking-widest text-center">ğŸ† å…¨æœæ’è¡Œæ¦œ</h3>
            <div id="leaderboard" class="space-y-3"></div>
        </div>
    </section>

    <section id="v-room" class="view">
        <div class="flex justify-between items-center mb-10">
            <div>
                <p class="text-slate-500 text-xs uppercase tracking-widest">Room ID</p>
                <h2 id="r-id" class="text-4xl font-black text-cyan-400">----</h2>
            </div>
            <button onclick="location.reload()" class="text-slate-500 text-sm">é›¢é–‹</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
            <div class="glass p-6 rounded-[2rem]">
                <h4 class="text-slate-500 text-xs font-bold mb-4 uppercase">æˆå“¡åˆ—è¡¨</h4>
                <div id="r-players" class="space-y-2"></div>
            </div>
            
            <div id="admin-controls" class="hidden glass p-6 rounded-[2rem] border-2 border-cyan-500/20">
                <h4 class="text-cyan-500 text-xs font-bold mb-6 uppercase">ç®¡ç†å“¡å¾Œå°ï¼šé¸æ“‡éŠæˆ²æ¨¡å¼</h4>
                <div class="grid grid-cols-1 gap-3 text-sm">
                    <button onclick="socket.emit('start_game','SPY')" class="bg-white/5 p-4 rounded-2xl text-left border border-white/5 hover:border-cyan-500 transition">ğŸ•µï¸ èª°æ˜¯è‡¥åº•</button>
                    <button onclick="socket.emit('start_game','MEMORY')" class="bg-white/5 p-4 rounded-2xl text-left border border-white/5 hover:border-cyan-500 transition">ğŸ§  è¨˜æ†¶å¡ç‰Œ</button>
                    <button onclick="socket.emit('start_game','BINGO')" class="bg-white/5 p-4 rounded-2xl text-left border border-white/5 hover:border-cyan-500 transition">ğŸ”¢ Bingo é€£ç·š</button>
                    <button onclick="socket.emit('start_game','GUESS')" class="bg-white/5 p-4 rounded-2xl text-left border border-white/5 hover:border-cyan-500 transition">âœï¸ ä½ è©±æˆ‘çŒœ</button>
                </div>
            </div>

            <div id="guest-waiting" class="glass p-6 rounded-[2rem] flex flex-col items-center justify-center text-slate-500 italic">
                <div class="animate-pulse mb-2 text-3xl">â³</div>
                ç­‰å¾…ç®¡ç†å“¡å•Ÿå‹•éŠæˆ²...
            </div>
        </div>
    </section>

    <script>
        const socket = io();
        let myUser, myPin, myAv = 'ğŸ¶';

        function go(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function selAv(av, el) {
            myAv = av;
            document.querySelectorAll('.av-btn').forEach(b => b.classList.remove('av-active'));
            el.classList.add('av-active');
        }

        function checkPin() {
            myPin = document.getElementById('i-pin').value;
            if (myPin.length === 4) socket.emit('check_pin', myPin);
        }

        socket.on('pin_result', res => {
            if (res.exists) {
                // å¦‚æœç©å®¶å·²å­˜åœ¨ï¼Œç›´æ¥é€²å¤§å»³
                socket.emit('save_profile', res.user);
            } else {
                // å¦‚æœæ˜¯æ–°ç©å®¶ï¼Œè·³åˆ°è¨­å®šé 
                go('v-setup');
            }
        });

        function saveProfile() {
            const name = document.getElementById('i-name').value;
            if (!name) return;
            socket.emit('save_profile', { pin: myPin, username: name, avatar: myAv });
        }

        socket.on('auth_success', u => {
            myUser = u;
            document.getElementById('u-info').innerText = `${u.avatar} ${u.username}`;
            document.getElementById('u-score').innerText = `${u.score} pt`;
            go('v-lobby');
        });

        function joinRoom() {
            const rid = document.getElementById('i-rid').value;
            if (rid) socket.emit('join_room', { roomId: rid, user: myUser });
        }

        socket.on('room_update', data => {
            go('v-room');
            document.getElementById('r-id').innerText = data.room.id;
            
            // é¡¯ç¤ºç©å®¶åˆ—è¡¨
            document.getElementById('r-players').innerHTML = data.room.players.map(p => `
                <div class="flex items-center gap-3 bg-white/5 p-3 rounded-2xl">
                    <span class="text-2xl">${p.avatar}</span>
                    <span class="font-bold">${p.username}</span>
                </div>
            `).join('');

            // ç®¡ç†å“¡æ¬Šé™åˆ¤æ–·
            if (data.isAdmin) {
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('guest-waiting').classList.add('hidden');
            } else {
                document.getElementById('admin-controls').classList.add('hidden');
                document.getElementById('guest-waiting').classList.remove('hidden');
            }
        });

        socket.on('rank_update', list => {
            document.getElementById('leaderboard').innerHTML = list.map((p, i) => `
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/5">
                    <span class="text-slate-400 font-bold">#${i+1} ${p.username}</span>
                    <span class="text-cyan-400 font-mono">${p.score} pt</span>
                </div>
            `).join('');
        });

        socket.on('room_created', rid => {
            socket.emit('join_room', { roomId: rid, user: myUser });
        });
        
        socket.on('goto_game', type => {
            // é€™è£¡æ¥å…¥ä½ ä¹‹å‰çš„éŠæˆ²é‚è¼¯...
            alert('éŠæˆ²é–‹å§‹ï¼š' + type);
        });
    </script>
</body>
</html>
