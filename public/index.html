<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayTogether - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #F2F0EB; color: #5F6368; }
        .morandi-card { background: white; border-radius: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .btn-blue { background-color: #A3B9C9; color: white; }
        .btn-green { background-color: #B4C4B8; color: white; }
        .cell-marked { background-color: #A3B9C9 !important; color: white; border: none; }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md morandi-card p-8 border border-gray-100 mt-10">
        
        <div id="step-0" class="space-y-6 text-center">
            <h1 class="text-2xl font-light tracking-widest text-gray-400 mb-8">PLAY TOGETHER</h1>
            <div onclick="selectGame('bingo')" class="p-6 border rounded-3xl cursor-pointer hover:bg-gray-50 transition-all border-blue-100">
                <h2 class="text-[#A3B9C9] font-bold">ç¶“å…¸ BINGO</h2>
                <p class="text-xs text-gray-400 mt-1">é€£ç·šã€å–Šè™Ÿã€å°æˆ°</p>
            </div>
            <div onclick="selectGame('spy')" class="p-6 border rounded-3xl cursor-pointer hover:bg-gray-50 transition-all border-green-100">
                <h2 class="text-[#B4C4B8] font-bold">èª°æ˜¯è‡¥åº•</h2>
                <p class="text-xs text-gray-400 mt-1">è§€å¯Ÿæè¿°ã€æ‰¾å‡ºå…§é¬¼</p>
            </div>
        </div>

        <div id="step-1" class="hidden text-center space-y-6">
            <h2 id="game-title" class="text-lg text-gray-300 tracking-widest uppercase"></h2>
            <input type="text" id="nameInp" class="w-full p-4 bg-gray-50 rounded-2xl text-center outline-none" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±">
            <button onclick="toLobby()" class="w-full btn-blue py-4 rounded-2xl font-medium">ä¸‹ä¸€æ­¥</button>
            <p onclick="location.reload()" class="text-[10px] text-gray-300 cursor-pointer">è¿”å›é¸æ“‡éŠæˆ²</p>
        </div>

        <div id="step-2" class="hidden space-y-6">
            <div class="flex border-b border-gray-100">
                <button id="tab-create" onclick="switchTab('create')" class="flex-1 py-3 text-sm font-bold border-b-2 border-[#A3B9C9] text-[#A3B9C9]">å»ºç«‹æˆ¿é–“</button>
                <button id="tab-join" onclick="switchTab('join')" class="flex-1 py-3 text-sm font-bold text-gray-300">åŠ å…¥æˆ¿é–“</button>
            </div>

            <div id="area-create" class="space-y-4">
                <input type="text" id="cRoomId" placeholder="è¨­å®š 4 ä½æ•¸æˆ¿è™Ÿ" class="w-full p-4 bg-gray-50 rounded-2xl text-center outline-none">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-300 pl-2">é è¨ˆäººæ•¸</label>
                        <input type="number" id="cMaxP" value="2" class="w-full p-3 bg-gray-50 rounded-xl text-center">
                    </div>
                    <div id="bingo-win-area" class="space-y-1">
                        <label class="text-[10px] text-gray-300 pl-2">å‹å‡ºç·šæ•¸</label>
                        <input type="number" id="cWinL" value="3" class="w-full p-3 bg-gray-50 rounded-xl text-center">
                    </div>
                </div>
                <button onclick="join(true)" class="w-full btn-blue py-4 rounded-2xl font-medium">å®Œæˆä¸¦é€²å…¥</button>
            </div>

            <div id="area-join" class="hidden space-y-4">
                <input type="text" id="jRoomId" placeholder="è¼¸å…¥å¥½å‹çš„æˆ¿è™Ÿ" class="w-full p-4 bg-gray-50 rounded-2xl text-center outline-none">
                <button onclick="join(false)" class="w-full btn-green py-4 rounded-2xl font-medium">ç«‹å³é€²å…¥</button>
            </div>
        </div>

        <div id="step-3-bingo" class="hidden">
            <div class="flex justify-between items-center mb-4 text-[10px] text-gray-300">
                <span>ä¾åºå¡«å…¥ 1-25</span>
                <span id="fill-hint" class="bg-blue-50 text-[#A3B9C9] px-3 py-1 rounded-full">ä¸‹å€‹æ•¸å­—: 1</span>
            </div>
            <div id="fillGrid" class="grid grid-cols-5 gap-2"></div>
            <button id="readyBtn" onclick="ready()" disabled class="w-full mt-6 bg-gray-100 text-white py-4 rounded-2xl">å¡«è™Ÿä¸­...</button>
        </div>

        <div id="step-4" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <div id="player-list" class="flex flex-wrap gap-1"></div>
                <div id="room-info" class="text-[10px] text-gray-300"></div>
            </div>
            
            <div id="bingo-ui" class="hidden">
                <div id="turn-display" class="w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-gray-50 text-gray-400">ç­‰å¾…æˆ¿ä¸»</div>
                <div id="gameGrid" class="grid grid-cols-5 gap-2"></div>
            </div>

            <div id="spy-ui" class="hidden text-center space-y-8 py-6">
                <div class="bg-gray-50 p-10 rounded-[2.5rem] border-2 border-dashed border-gray-100">
                    <p class="text-[10px] text-gray-300 tracking-[0.2em] mb-4">YOUR SECRET WORD</p>
                    <h2 id="spy-word-display" class="text-4xl font-bold text-slate-500">????</h2>
                </div>
                <p class="text-xs text-gray-400 leading-relaxed">è«‹è¼ªæµæè¿°ä½ çš„è©èª<br>æ‰¾å‡ºé‚£å€‹æ‹¿åˆ°ã€Œä¸åŒè©èªã€çš„äººï¼</p>
            </div>

            <div id="log" class="text-center text-[10px] italic text-gray-300 mt-6 min-h-[1.5rem]"></div>
            
            <div id="host-controls" class="hidden space-y-2 mt-6">
                <p id="start-condition" class="text-center text-[10px] text-gray-300"></p>
                <button id="startBtn" onclick="sendStart()" class="w-full btn-blue py-4 rounded-2xl font-medium shadow-lg">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let selectedGame = '', myName, curRoom, isHost = false, fillCount = 1, myLayout = Array(25).fill(null), boardState = Array(25).fill(false), isMyTurn = false;

        function selectGame(g) {
            selectedGame = g;
            document.getElementById('step-0').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('game-title').innerText = (g==='bingo'?'BINGO':'èª°æ˜¯è‡¥åº•');
            if(g === 'spy') document.getElementById('bingo-win-area').classList.add('hidden');
        }

        function toLobby() {
            myName = document.getElementById('nameInp').value;
            if(!myName) return alert("è«‹è¼¸å…¥æš±ç¨±");
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
        }

        function switchTab(type) {
            const isCreate = type === 'create';
            document.getElementById('area-create').classList.toggle('hidden', !isCreate);
            document.getElementById('area-join').classList.toggle('hidden', isCreate);
            document.getElementById('tab-create').className = `flex-1 py-3 text-sm font-bold border-b-2 ${isCreate?'border-[#A3B9C9] text-[#A3B9C9]':'border-transparent text-gray-300'}`;
            document.getElementById('tab-join').className = `flex-1 py-3 text-sm font-bold border-b-2 ${!isCreate?'border-[#B4C4B8] text-[#B4C4B8]':'border-transparent text-gray-300'}`;
        }

        function join(h) {
            isHost = h;
            curRoom = h ? document.getElementById('cRoomId').value : document.getElementById('jRoomId').value;
            if(!curRoom) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
            
            socket.emit('join_room', { 
                roomId: curRoom, username: myName, gameType: selectedGame,
                maxPlayers: document.getElementById('cMaxP').value,
                winLines: document.getElementById('cWinL').value
            });
            
            document.getElementById('step-2').classList.add('hidden');
            if(selectedGame === 'bingo') initFill(); else ready();
        }

        function initFill() {
            document.getElementById('step-3-bingo').classList.remove('hidden');
            const g = document.getElementById('fillGrid'); g.innerHTML = '';
            for(let i=0; i<25; i++) {
                const b = document.createElement('button');
                b.className = "aspect-square bg-gray-50 rounded-xl text-gray-300 font-bold text-sm";
                b.onclick = () => {
                    if(myLayout[i]) return;
                    myLayout[i] = fillCount; b.innerText = fillCount;
                    b.className = "aspect-square bg-white border border-blue-100 rounded-xl text-[#A3B9C9] font-bold shadow-sm";
                    fillCount++;
                    if(fillCount > 25) {
                        document.getElementById('readyBtn').disabled = false;
                        document.getElementById('readyBtn').className = "w-full mt-6 btn-blue py-4 rounded-2xl";
                        document.getElementById('readyBtn').innerText = "æº–å‚™å¥½äº†";
                    } else document.getElementById('fill-hint').innerText = `ä¸‹å€‹æ•¸å­—: ${fillCount}`;
                };
                g.appendChild(b);
            }
        }

        function ready() {
            document.getElementById('step-3-bingo').classList.add('hidden');
            document.getElementById('step-4').classList.remove('hidden');
            document.getElementById('room-info').innerText = `ROOM: ${curRoom}`;
            
            if(selectedGame === 'bingo') {
                document.getElementById('bingo-ui').classList.remove('hidden');
                const g = document.getElementById('gameGrid'); g.innerHTML = '';
                myLayout.forEach((num) => {
                    const b = document.createElement('button');
                    b.className = "aspect-square bg-white border border-gray-100 rounded-xl text-lg font-medium text-gray-400";
                    b.innerText = num; b.id = `cell-${num}`;
                    b.onclick = () => { if(isMyTurn) { socket.emit('game_move', { roomId: curRoom, number: num }); mark(num); } };
                    g.appendChild(b);
                });
            } else {
                document.getElementById('spy-ui').classList.remove('hidden');
            }
        }

        function sendStart() { socket.emit('start_game', curRoom); }

        function mark(num) {
            const btn = document.getElementById(`cell-${num}`);
            if(btn && !btn.disabled) {
                btn.disabled = true;
                btn.className = "aspect-square cell-marked rounded-xl text-lg font-bold shadow-inner opacity-80";
                boardState[myLayout.indexOf(num)] = true;
                isMyTurn = false; updateBingoTurnUI(); checkBingoWin();
            }
        }

        function checkBingoWin() {
            let lines = 0;
            const check = (arr) => arr.every(i => boardState[i]);
            for(let i=0; i<5; i++) {
                if(check([i*5, i*5+1, i*5+2, i*5+3, i*5+4])) lines++;
                if(check([i, i+5, i+10, i+15, i+20])) lines++;
            }
            if(check([0,6,12,18,24])) lines++;
            if(check([4,8,12,16,20])) lines++;
            if(lines >= 3) socket.emit('player_win', { roomId: curRoom });
        }

        function updateBingoTurnUI(nextName) {
            const t = document.getElementById('turn-display');
            if(isMyTurn) {
                t.innerText = "YOUR TURN | è«‹å–Šè™Ÿ"; t.className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold btn-green animate-pulse";
            } else {
                t.innerText = nextName ? `WAITING | è¼ªåˆ° ${nextName}` : "WAITING...";
                t.className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-gray-50 text-gray-300";
            }
        }

        socket.on('room_update', (d) => {
            const list = document.getElementById('player-list');
            list.innerHTML = d.players.map(p => `<span class="px-3 py-1 bg-gray-50 text-[10px] rounded-full border border-gray-100">${p.name}${p.id===d.host?'â˜…':''}</span>`).join('');
            
            if(isHost && !d.gameStarted) {
                document.getElementById('host-controls').classList.remove('hidden');
                const cond = document.getElementById('start-condition');
                if(d.players.length < d.maxPlayers) {
                    cond.innerText = `ç­‰å¾…äººæ•¸æ»¿é¡ (${d.players.length}/${d.maxPlayers})`;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('startBtn').className = "w-full bg-gray-100 text-white py-4 rounded-2xl cursor-not-allowed";
                } else {
                    cond.innerText = "äººæ•¸å·²æ»¿ï¼Œå¯ä»¥é–‹å§‹éŠæˆ²";
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('startBtn').className = "w-full btn-blue py-4 rounded-2xl font-medium shadow-lg";
                }
            }
        });

        socket.on('game_begin', (d) => {
            document.getElementById('host-controls').classList.add('hidden');
            isMyTurn = (socket.id === d.nextTurnId);
            updateBingoTurnUI(d.nextTurnName);
        });

        socket.on('receive_move', (d) => {
            mark(d.number);
            isMyTurn = (socket.id === d.nextTurnId);
            updateBingoTurnUI(d.nextTurnName);
            document.getElementById('log').innerText = `${d.senderName} å–Šäº†è™Ÿç¢¼ ${d.number}`;
        });

        socket.on('receive_spy_word', (d) => {
            document.getElementById('spy-word-display').innerText = d.word;
            document.getElementById('host-controls').classList.add('hidden');
        });

        socket.on('game_over', (d) => {
            alert(`ğŸ‰ éŠæˆ²çµæŸï¼è´å®¶æ˜¯ï¼š${d.winner}`);
            location.reload();
        });
    </script>
</body>
</html>
