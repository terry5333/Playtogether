<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Together - Morandi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #F2F0EB; color: #5F6368; }
        .btn-blue { background-color: #A3B9C9; color: white; }
        .btn-green { background-color: #B4C4B8; color: white; }
        .cell-marked { background-color: #A3B9C9 !important; color: white; border: none; }
        .my-turn { background-color: #B4C4B8 !important; color: white; animation: pulse 2s infinite; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">
    <div class="w-full max-w-md bg-white rounded-[2rem] shadow-sm p-8 border border-gray-100">
        <div id="step-1" class="text-center space-y-6">
            <h1 class="text-xl tracking-widest text-gray-400">BINGO</h1>
            <input type="text" id="nameInp" class="w-full p-4 bg-gray-50 rounded-2xl text-center outline-none" placeholder="è¼¸å…¥æš±ç¨±">
            <button onclick="toLobby()" class="w-full btn-blue py-4 rounded-2xl font-medium">é€²å…¥å¤§å»³</button>
        </div>

        <div id="step-2" class="hidden space-y-8">
            <div class="space-y-3">
                <h3 class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">å‰µå»ºæˆ¿é–“</h3>
                <input type="text" id="cRoomId" placeholder="æˆ¿è™Ÿ" class="w-full p-3 bg-gray-50 rounded-xl outline-none">
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <input type="number" id="cMaxP" value="2" class="p-2 bg-gray-50 rounded-lg text-center" title="äººæ•¸">
                    <input type="number" id="cWinL" value="3" class="p-2 bg-gray-50 rounded-lg text-center" title="ç·šæ•¸">
                </div>
                <button onclick="join(true)" class="w-full btn-blue py-3 rounded-xl">å»ºç«‹ä¸¦è¨­å®šè¦å‰‡</button>
            </div>
            <div class="space-y-3">
                <h3 class="text-[10px] font-bold text-gray-300 uppercase tracking-widest text-right">åŠ å…¥å¥½å‹</h3>
                <input type="text" id="jRoomId" placeholder="æˆ¿è™Ÿ" class="w-full p-3 bg-gray-50 rounded-xl outline-none">
                <button onclick="join(false)" class="w-full btn-green py-3 rounded-xl">ç«‹å³åŠ å…¥</button>
            </div>
        </div>

        <div id="step-3" class="hidden">
            <div class="flex justify-between items-center mb-6 text-[10px] font-bold text-gray-300">
                <span>é»æ“Šæ ¼å­ä¾åºå¡«å…¥ 1-25</span>
                <span id="fill-hint" class="btn-blue px-2 py-1 rounded-full">å¡«å…¥: 1</span>
            </div>
            <div id="fillGrid" class="grid grid-cols-5 gap-2"></div>
            <button id="readyBtn" onclick="ready()" disabled class="w-full mt-8 bg-gray-200 text-white py-4 rounded-2xl cursor-not-allowed">ç­‰å¾…å¡«è™Ÿå®Œæˆ</button>
        </div>

        <div id="step-4" class="hidden">
            <div id="turn-display" class="w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-gray-100 text-gray-400">ç­‰å¾…æˆ¿ä¸»é–‹å§‹éŠæˆ²</div>
            <div id="player-list" class="flex flex-wrap gap-2 mb-6"></div>
            <div id="gameGrid" class="grid grid-cols-5 gap-2 mb-6"></div>
            <div id="log" class="text-center text-[10px] italic text-gray-300"></div>
            <button id="startBtn" onclick="sendStart()" class="hidden w-full btn-blue py-3 rounded-xl mt-4">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, curRoom, myLayout = Array(25).fill(null), fillCount = 1, boardState = Array(25).fill(false), isGameOver = false, isMyTurn = false, isHost = false;

        function toLobby() {
            myName = document.getElementById('nameInp').value;
            if(!myName) return;
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
        }

        function join(h) {
            const r = h ? document.getElementById('cRoomId').value : document.getElementById('jRoomId').value;
            if(!r) return;
            curRoom = r; isHost = h;
            socket.emit('join_room', { roomId: r, username: myName, maxPlayers: document.getElementById('cMaxP').value, winLines: document.getElementById('cWinL').value });
            document.getElementById('step-2').classList.add('hidden');
            initFill();
        }

        function initFill() {
            document.getElementById('step-3').classList.remove('hidden');
            const g = document.getElementById('fillGrid');
            for(let i=0; i<25; i++) {
                const b = document.createElement('button');
                b.className = "aspect-square bg-gray-50 rounded-xl text-gray-300 font-bold hover:bg-gray-100 transition-all";
                b.onclick = () => {
                    if(myLayout[i]) return;
                    myLayout[i] = fillCount; b.innerText = fillCount;
                    b.className = "aspect-square bg-white border border-blue-100 rounded-xl text-blue-400 font-bold shadow-sm";
                    fillCount++;
                    if(fillCount > 25) {
                        document.getElementById('readyBtn').disabled = false;
                        document.getElementById('readyBtn').className = "w-full mt-8 btn-blue py-4 rounded-2xl";
                        document.getElementById('readyBtn').innerText = "é€²å…¥æˆ¿é–“é å‚™å€";
                    } else document.getElementById('fill-hint').innerText = `å¡«å…¥: ${fillCount}`;
                };
                g.appendChild(b);
            }
        }

        function ready() {
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.remove('hidden');
            if(isHost) document.getElementById('startBtn').classList.remove('hidden');
            const g = document.getElementById('gameGrid');
            myLayout.forEach((num, idx) => {
                const b = document.createElement('button');
                b.className = "aspect-square bg-white border border-gray-100 rounded-xl text-lg font-medium text-gray-400";
                b.innerText = num; b.id = `cell-${num}`;
                b.onclick = () => {
                    if(!isMyTurn || isGameOver) return;
                    socket.emit('game_move', { roomId: curRoom, number: num });
                    mark(num);
                };
                g.appendChild(b);
            });
        }

        function sendStart() { socket.emit('start_game', curRoom); }

        function mark(num) {
            const btn = document.getElementById(`cell-${num}`);
            if(btn && !btn.disabled) {
                btn.disabled = true;
                btn.className = "aspect-square cell-marked rounded-xl text-lg font-bold shadow-inner opacity-80";
                boardState[myLayout.indexOf(num)] = true;
                isMyTurn = false; updateUI(); check();
            }
        }

        function check() {
            let lines = 0;
            const checkLine = (indices) => indices.every(i => boardState[i]);
            for(let i=0; i<5; i++) {
                if(checkLine([i*5, i*5+1, i*5+2, i*5+3, i*5+4])) lines++;
                if(checkLine([i, i+5, i+10, i+15, i+20])) lines++;
            }
            if(checkLine([0, 6, 12, 18, 24])) lines++;
            if(checkLine([4, 8, 12, 16, 20])) lines++;
            if(lines >= 3) socket.emit('player_win', { roomId: curRoom }); // é€™é‚Šç·šæ•¸å¯é€£å‹• Server
        }

        function updateUI(nextName) {
            const t = document.getElementById('turn-display');
            if(isGameOver) return;
            if(isMyTurn) {
                t.innerText = "YOUR TURN | è«‹å–Šè™Ÿç¢¼"; t.className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold my-turn";
            } else {
                t.innerText = nextName ? `WAITING | è¼ªåˆ° ${nextName}` : "WAITING | ç­‰å¾…å°æ‰‹";
                t.className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-gray-100 text-gray-400";
            }
        }

        socket.on('room_update', (d) => {
            const list = document.getElementById('player-list');
            list.innerHTML = d.players.map(p => `<span class="px-3 py-1 bg-gray-50 text-[10px] rounded-lg">${p.name}${p.id===d.host?'â˜…':''}</span>`).join('');
        });

        socket.on('game_begin', (d) => {
            document.getElementById('startBtn').classList.add('hidden');
            isMyTurn = (socket.id === d.nextTurnId);
            updateUI(d.nextTurnName);
        });

        socket.on('receive_move', (d) => {
            mark(d.number);
            isMyTurn = (socket.id === d.nextTurnId);
            updateUI(d.nextTurnName);
            document.getElementById('log').innerText = `${d.senderName} å–Šäº† ${d.number}`;
        });

        socket.on('game_over', (d) => {
            isGameOver = true;
            document.getElementById('turn-display').innerText = `ğŸ† WINNER: ${d.winner}`;
            document.getElementById('turn-display').className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-yellow-400 text-white";
            alert(`éŠæˆ²çµæŸï¼æ­å–œ ${d.winner} ç²å‹ï¼`);
        });
    </script>
</body>
</html>
