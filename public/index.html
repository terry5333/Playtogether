<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PartyBox 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --sand: #F2EBE1; --blue: #A2C2D8; }
        body { background: var(--sand); font-family: sans-serif; color: #5D6D7E; }
        .card { background: white; border-radius: 2.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.03); }
        .btn { border-radius: 1.25rem; font-weight: bold; transition: 0.2s; cursor: pointer; border:none; }
        .btn:active { transform: scale(0.95); }
        .hidden { display: none !important; }
        .mem-card { height: 80px; background: #e2e8f0; border-radius: 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
        .mem-card.flipped { background: white; transform: rotateY(180deg); }
        .mem-card.matched { background: #d1fae5; color: #059669; cursor: default; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="toast" class="fixed top-8 bg-black/80 text-white px-8 py-3 rounded-full opacity-0 transition-all z-[999]"></div>

    <section id="view-auth" class="card p-10 w-full max-w-md space-y-6 text-center">
        <h1 class="text-4xl font-black text-[#A2C2D8]">PartyBox</h1>
        <div class="flex justify-center gap-2" id="avatar-list">
            <button onclick="selAv('ğŸ¶')" class="text-2xl p-2 border-2 rounded-xl border-blue-400">ğŸ¶</button>
            <button onclick="selAv('ğŸ±')" class="text-2xl p-2 border-2 rounded-xl">ğŸ±</button>
            <button onclick="selAv('ğŸ¦Š')" class="text-2xl p-2 border-2 rounded-xl">ğŸ¦Š</button>
            <button onclick="selAv('ğŸ°')" class="text-2xl p-2 border-2 rounded-xl">ğŸ°</button>
        </div>
        <input id="auth-u" type="text" placeholder="å¸³è™Ÿ" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
        <input id="auth-p" type="password" placeholder="å¯†ç¢¼" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
        <div class="flex gap-2">
            <button onclick="doAuth('login')" class="flex-1 p-4 btn bg-[#A2C2D8] text-white">ç™»å…¥</button>
            <button onclick="doAuth('register')" class="flex-1 p-4 btn bg-gray-200">è¨»å†Š</button>
        </div>
    </section>

    <section id="view-lobby" class="hidden card p-8 w-full max-w-md space-y-6 text-center">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span id="my-av" class="text-3xl">ğŸ¶</span>
                <span id="my-name" class="font-bold text-lg">---</span>
            </div>
            <span id="my-score" class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-xs font-bold">0 pt</span>
        </div>
        
        <div id="leaderboard" class="bg-gray-50 p-4 rounded-3xl text-left">
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">ğŸ† å…¨æœé«˜åˆ†æ’è¡Œ</h4>
            <div id="leader-list" class="space-y-1 text-sm"></div>
        </div>

        <div id="room-actions" class="space-y-3">
            <button onclick="socket.emit('create_room')" class="w-full p-4 btn bg-blue-400 text-white">å»ºç«‹æ–°éŠæˆ²</button>
            <div class="flex gap-2">
                <input id="room-id" type="number" placeholder="è¼¸å…¥æˆ¿è™Ÿ" class="w-2/3 p-4 bg-gray-100 rounded-2xl outline-none">
                <button onclick="join()" class="w-1/3 btn bg-gray-200">åŠ å…¥</button>
            </div>
        </div>

        <div id="room-wait" class="hidden space-y-4">
            <h2 id="disp-rid" class="text-4xl font-black">----</h2>
            <div id="player-list" class="flex flex-wrap gap-2 justify-center"></div>
            <div id="host-zone" class="hidden border-t pt-4 space-y-2">
                <button onclick="socket.emit('host_setup_game',{type:'memory'})" class="w-full p-4 btn bg-blue-100 text-blue-500">ğŸ§  è¨˜æ†¶å¡ç‰Œ</button>
                <button onclick="socket.emit('host_setup_game',{type:'bingo'})" class="w-full p-4 btn bg-green-100 text-green-500">ğŸ² æ•¸å­—è³“æœ</button>
                <button onclick="socket.emit('host_setup_game',{type:'draw'})" class="w-full p-4 btn bg-orange-100 text-orange-500">ğŸ¨ ä½ è©±æˆ‘çŒœ</button>
            </div>
        </div>
    </section>

    <section id="view-memory" class="hidden card p-6 w-full max-w-md text-center">
        <h2 class="text-xl font-black mb-4">è¨˜æ†¶å¡ç‰Œ ğŸ§ </h2>
        <div id="memory-grid" class="grid grid-cols-4 gap-2"></div>
    </section>

    <script>
        const socket = io();
        let myUser = null, selAvatar = 'ğŸ¶';

        function v(id) { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function showT(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 2000); }
        function selAv(a) { 
            selAvatar = a;
            document.querySelectorAll('#avatar-list button').forEach(b => b.classList.remove('border-blue-400'));
            event.target.classList.add('border-blue-400');
        }

        // ç™»å…¥è¨»å†Š
        function doAuth(type) {
            const username = document.getElementById('auth-u').value;
            const password = document.getElementById('auth-p').value;
            if(!username || !password) return alert("è«‹å¡«å¯«å¸³å¯†");
            socket.emit('auth_action', { type, username, password, avatar: selAvatar });
        }

        socket.on('auth_success', user => {
            myUser = user;
            document.getElementById('my-av').innerText = user.avatar;
            document.getElementById('my-name').innerText = user.username;
            document.getElementById('my-score').innerText = user.score + " pt";
            v('view-lobby');
        });

        socket.on('leaderboard_update', list => {
            document.getElementById('leader-list').innerHTML = list.map((u, i) => `
                <div class="flex justify-between">
                    <span>${i+1}. ${u.avatar} ${u.username}</span>
                    <span class="font-bold">${u.score}</span>
                </div>
            `).join('');
            if(myUser) {
                const me = list.find(u => u.username === myUser.username);
                if(me) document.getElementById('my-score').innerText = me.score + " pt";
            }
        });

        // æˆ¿é–“é‚è¼¯
        function join() {
            const rid = document.getElementById('room-id').value;
            if(rid) socket.emit('join_room', { roomId: rid, user: myUser });
        }

        socket.on('room_created', d => socket.emit('join_room', { roomId: d.roomId, user: myUser }));
        socket.on('room_update', d => {
            v('view-lobby');
            document.getElementById('room-actions').classList.add('hidden');
            document.getElementById('room-wait').classList.remove('hidden');
            document.getElementById('disp-rid').innerText = d.roomId;
            document.getElementById('host-zone').classList.toggle('hidden', socket.id !== d.hostId);
            document.getElementById('player-list').innerHTML = d.players.map(p => `
                <div class="flex flex-col items-center p-2 bg-gray-50 rounded-2xl w-20">
                    <span class="text-2xl">${p.avatar}</span>
                    <span class="text-[10px] font-bold truncate w-full text-center">${p.username}</span>
                </div>
            `).join('');
        });

        // è¨˜æ†¶å¡ç‰Œå‰ç«¯
        socket.on('game_begin', d => {
            if(d.type === 'memory') {
                v('view-memory');
                const grid = document.getElementById('memory-grid');
                grid.innerHTML = '';
                for(let i=0; i<d.cardCount; i++) {
                    const card = document.createElement('div');
                    card.className = "mem-card";
                    card.dataset.idx = i;
                    card.onclick = () => socket.emit('memory_flip', i);
                    grid.appendChild(card);
                }
            }
        });

        socket.on('memory_sync_flip', flipped => {
            flipped.forEach(f => {
                const el = document.querySelector(`[data-idx="${f.idx}"]`);
                el.innerText = f.val;
                el.classList.add('flipped');
            });
        });

        socket.on('memory_flip_back', () => {
            document.querySelectorAll('.mem-card:not(.matched)').forEach(el => {
                el.innerText = '';
                el.classList.remove('flipped');
            });
        });

        socket.on('memory_match_success', matched => {
            matched.forEach(idx => {
                const el = document.querySelector(`[data-idx="${idx}"]`);
                el.classList.add('matched');
                el.onclick = null;
            });
        });

        socket.on('game_over', d => {
            alert(`ğŸŠ éŠæˆ²çµæŸï¼è´å®¶æ˜¯ ${d.winner}`);
            v('view-lobby'); // è¿”å›æˆ¿é–“ç•«é¢
        });

        socket.on('toast', m => showT(m));
    </script>
</body>
</html>
