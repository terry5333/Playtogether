<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayTogether - å¤šéŠæˆ²åˆè¼¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #F2F0EB; color: #5F6368; font-family: sans-serif; }
        .morandi-card { background: white; border-radius: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .btn-blue { background-color: #A3B9C9; color: white; transition: all 0.3s; }
        .btn-blue:hover { opacity: 0.8; }
        .btn-green { background-color: #B4C4B8; color: white; }
        .cell-marked { background-color: #A3B9C9 !important; color: white; border: none; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md morandi-card p-8 border border-gray-100">
        
        <div id="step-0" class="space-y-6">
            <h1 class="text-2xl text-center font-light tracking-widest text-gray-400 mb-8 uppercase">PlayTogether</h1>
            <div onclick="selectGame('bingo')" class="p-6 border rounded-3xl cursor-pointer hover:bg-gray-50 transition-all border-blue-100">
                <h2 class="text-[#A3B9C9] font-bold">ç¶“å…¸ BINGO</h2>
                <p class="text-xs text-gray-400 mt-1">è‡ªè¨‚è™Ÿç¢¼ï¼Œé€£ç·šå°æˆ°</p>
            </div>
            <div onclick="selectGame('spy')" class="p-6 border rounded-3xl cursor-pointer hover:bg-gray-50 transition-all border-green-100">
                <h2 class="text-[#B4C4B8] font-bold">èª°æ˜¯è‡¥åº•</h2>
                <p class="text-xs text-gray-400 mt-1">èªæ–‡é‚è¼¯ï¼Œæ‰¾å‡ºéš±è—çš„ç©å®¶</p>
            </div>
        </div>

        <div id="step-1" class="hidden text-center space-y-6">
            <h2 id="game-title" class="text-lg text-gray-300 uppercase tracking-widest"></h2>
            <input type="text" id="nameInp" class="w-full p-4 bg-gray-50 rounded-2xl text-center outline-none" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±">
            <button onclick="toLobby()" class="w-full btn-blue py-4 rounded-2xl font-medium">ç¢ºå®š</button>
        </div>

        <div id="step-2" class="hidden space-y-8">
            <div class="space-y-3">
                <h3 class="text-[10px] font-bold text-gray-300 uppercase">å‰µå»ºæˆ¿é–“</h3>
                <input type="text" id="roomIdInp" placeholder="è¨­å®šæˆ¿è™Ÿ" class="w-full p-3 bg-gray-50 rounded-xl outline-none">
                <div id="bingo-settings" class="grid grid-cols-2 gap-2">
                    <input type="number" id="cMaxP" value="2" class="p-2 bg-gray-50 rounded-lg text-center text-xs" title="äººæ•¸">
                    <input type="number" id="cWinL" value="3" class="p-2 bg-gray-50 rounded-lg text-center text-xs" title="ç·šæ•¸">
                </div>
                <button onclick="join(true)" class="w-full btn-blue py-3 rounded-xl text-sm">å»ºç«‹æˆ¿é–“</button>
            </div>
            <div class="relative py-2 text-center text-[10px] text-gray-200 uppercase">OR</div>
            <button onclick="join(false)" class="w-full btn-green py-3 rounded-xl text-sm">åŠ å…¥ç¾æœ‰æˆ¿é–“</button>
        </div>

        <div id="step-3-bingo" class="hidden">
            <div class="flex justify-between items-center mb-6 text-[10px] text-gray-300 font-bold">
                <span>è‡ªè¨‚ 1-25 ä½ç½®</span>
                <span id="fill-hint" class="bg-gray-100 px-2 py-1 rounded-full">å¡«å…¥: 1</span>
            </div>
            <div id="fillGrid" class="grid grid-cols-5 gap-2"></div>
            <button id="readyBtn" onclick="ready()" disabled class="w-full mt-8 bg-gray-200 text-white py-4 rounded-2xl">å¡«æ»¿æ•¸å­—å¾Œé–‹å§‹</button>
        </div>

        <div id="step-4" class="hidden">
            <div id="player-list" class="flex flex-wrap gap-2 mb-4"></div>
            
            <div id="bingo-ui" class="hidden">
                <div id="turn-display" class="w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-gray-100">ç­‰å¾…é–‹å§‹</div>
                <div id="gameGrid" class="grid grid-cols-5 gap-2 mb-6"></div>
            </div>

            <div id="spy-ui" class="hidden text-center space-y-6">
                <div class="p-8 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
                    <p class="text-[10px] text-gray-400 uppercase mb-2 tracking-widest">æ‚¨çš„è©èª</p>
                    <h2 id="spy-word-display" class="text-3xl font-bold text-slate-600">????</h2>
                </div>
                <p class="text-xs text-gray-400">è«‹è¼ªæµæè¿°è©èªï¼Œæ‰¾å‡ºè‡¥åº•ï¼</p>
            </div>

            <div id="log" class="text-center text-[10px] italic text-gray-300 mt-4 min-h-[20px]"></div>
            <button id="startBtn" onclick="sendStart()" class="hidden w-full btn-blue py-3 rounded-xl mt-6">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let selectedGame = '', myName, curRoom, isHost = false, fillCount = 1, myLayout = Array(25).fill(null), boardState = Array(25).fill(false), isMyTurn = false;

        function selectGame(g) {
            selectedGame = g;
            document.getElementById('step-0').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('game-title').innerText = g.toUpperCase();
            if(g === 'spy') document.getElementById('bingo-settings').classList.add('hidden');
        }

        function toLobby() {
            myName = document.getElementById('nameInp').value;
            if(!myName) return;
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
        }

        function join(h) {
            isHost = h;
            curRoom = document.getElementById('roomIdInp').value || "Default";
            socket.emit('join_room', { 
                roomId: curRoom, username: myName, gameType: selectedGame,
                maxPlayers: document.getElementById('cMaxP').value,
                winLines: document.getElementById('cWinL').value
            });
            document.getElementById('step-2').classList.add('hidden');
            if(selectedGame === 'bingo') initFill(); else ready();
        }

        function initFill() {
            document.getElementById('step-3-bingo').classList.remove('hidden');
            const g = document.getElementById('fillGrid'); g.innerHTML = '';
            for(let i=0; i<25; i++) {
                const b = document.createElement('button');
                b.className = "aspect-square bg-gray-50 rounded-xl text-gray-300 font-bold";
                b.onclick = () => {
                    if(myLayout[i]) return;
                    myLayout[i] = fillCount; b.innerText = fillCount;
                    b.className = "aspect-square bg-white border border-blue-100 rounded-xl text-blue-400 font-bold shadow-sm";
                    fillCount++;
                    if(fillCount > 25) {
                        document.getElementById('readyBtn').disabled = false;
                        document.getElementById('readyBtn').className = "w-full mt-8 btn-blue py-4 rounded-2xl";
                    } else document.getElementById('fill-hint').innerText = `å¡«å…¥: ${fillCount}`;
                };
                g.appendChild(b);
            }
        }

        function ready() {
            document.getElementById('step-3-bingo').classList.add('hidden');
            document.getElementById('step-4').classList.remove('hidden');
            if(isHost) document.getElementById('startBtn').classList.remove('hidden');
            
            if(selectedGame === 'bingo') {
                document.getElementById('bingo-ui').classList.remove('hidden');
                const g = document.getElementById('gameGrid'); g.innerHTML = '';
                myLayout.forEach((num, idx) => {
                    const b = document.createElement('button');
                    b.className = "aspect-square bg-white border border-gray-100 rounded-xl text-lg font-medium text-gray-400";
                    b.innerText = num; b.id = `cell-${num}`;
                    b.onclick = () => { if(isMyTurn) { socket.emit('game_move', { roomId: curRoom, number: num }); mark(num); } };
                    g.appendChild(b);
                });
            } else {
                document.getElementById('spy-ui').classList.remove('hidden');
            }
        }

        function sendStart() { socket.emit('start_game', curRoom); }

        function mark(num) {
            const btn = document.getElementById(`cell-${num}`);
            if(btn && !btn.disabled) {
                btn.disabled = true;
                btn.className = "aspect-square cell-marked rounded-xl text-lg font-bold";
                boardState[myLayout.indexOf(num)] = true;
                isMyTurn = false; updateBingoTurnUI(); checkBingoWin();
            }
        }

        function checkBingoWin() {
            let lines = 0;
            const check = (arr) => arr.every(i => boardState[i]);
            for(let i=0; i<5; i++) {
                if(check([i*5, i*5+1, i*5+2, i*5+3, i*5+4])) lines++;
                if(check([i, i+5, i+10, i+15, i+20])) lines++;
            }
            if(check([0,6,12,18,24])) lines++;
            if(check([4,8,12,16,20])) lines++;
            if(lines >= 3) socket.emit('player_win', { roomId: curRoom });
        }

        function updateBingoTurnUI(nextName) {
            const t = document.getElementById('turn-display');
            if(isMyTurn) {
                t.innerText = "è¼ªåˆ°ä½ äº†"; t.className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-[#B4C4B8] text-white";
            } else {
                t.innerText = nextName ? `è¼ªåˆ° ${nextName}` : "ç­‰å¾…ä¸­";
                t.className = "w-full py-2 mb-4 rounded-xl text-center text-[10px] font-bold bg-gray-100 text-gray-400";
            }
        }

        socket.on('room_update', (d) => {
            const list = document.getElementById('player-list');
            list.innerHTML = d.players.map(p => `<span class="px-3 py-1 bg-gray-50 text-[10px] rounded-full border border-gray-100">${p.name}${p.id===d.host?'â˜…':''}</span>`).join('');
        });

        socket.on('game_begin', (d) => {
            document.getElementById('startBtn').classList.add('hidden');
            isMyTurn = (socket.id === d.nextTurnId);
            updateBingoTurnUI(d.nextTurnName);
        });

        socket.on('receive_move', (d) => {
            mark(d.number);
            isMyTurn = (socket.id === d.nextTurnId);
            updateBingoTurnUI(d.nextTurnName);
        });

        socket.on('receive_spy_word', (d) => {
            document.getElementById('spy-word-display').innerText = d.word;
            document.getElementById('startBtn').classList.add('hidden');
        });

        socket.on('game_over', (d) => {
            alert(`ğŸ† å„ªå‹è€…ï¼š${d.winner}`);
            location.reload();
        });
    </script>
</body>
</html>
