<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTY BOX 旗艦版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        .player-tag { background: #1e293b; padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: bold; border: 1px solid #334155; }
    </style>
</head>
<body class="p-4">

    <main id="main-menu" class="max-w-md mx-auto space-y-4 pt-20">
        <h1 class="text-4xl font-black text-center mb-10 italic">PARTY<span class="text-blue-500">BOX</span></h1>
        <button onclick="showAction('create')" class="w-full glass p-6 rounded-2xl text-left border-l-4 border-blue-500">
            <b class="text-xl">創建房間</b><p class="text-slate-400 text-sm">你是房主，可以選擇模式</p>
        </button>
        <button onclick="showAction('join')" class="w-full glass p-6 rounded-2xl text-left border-l-4 border-orange-500">
            <b class="text-xl">加入房間</b><p class="text-slate-400 text-sm">輸入房號與好友同樂</p>
        </button>
    </main>

    <section id="action-panel" class="hidden max-w-md mx-auto space-y-4 pt-20">
        <input type="text" id="username" placeholder="你的暱稱" class="w-full bg-slate-800 p-4 rounded-xl outline-none">
        <input type="text" id="roomIdInput" placeholder="輸入 4 位數房號" class="hidden w-full bg-slate-800 p-4 rounded-xl outline-none">
        <button id="confirm-btn" class="w-full bg-blue-600 p-4 rounded-xl font-bold text-lg">進入大廳</button>
    </section>

    <section id="lobby-zone" class="hidden max-w-md mx-auto space-y-4">
        <div class="glass p-6 rounded-[2rem] space-y-6 text-center">
            <h2 id="room-display" class="text-2xl font-black text-blue-400">房號：----</h2>
            
            <div id="player-list" class="flex flex-wrap gap-2 justify-center"></div>

            <hr class="border-slate-700">

            <div id="host-controls" class="hidden space-y-3">
                <p class="text-xs text-slate-500 font-bold">你是房主，請選擇遊戲模式：</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="startGame('bingo')" class="bg-slate-800 p-4 rounded-xl font-bold border-l-4 border-blue-500 hover:bg-slate-700">賓果連連看</button>
                    <button onclick="startGame('spy')" class="bg-slate-800 p-4 rounded-xl font-bold border-l-4 border-green-500 hover:bg-slate-700">誰是臥底</button>
                    <button onclick="startGame('draw')" class="bg-slate-800 p-4 rounded-xl font-bold border-l-4 border-orange-500 hover:bg-slate-700">你畫我猜</button>
                </div>
            </div>

            <p id="wait-msg" class="text-slate-500 animate-pulse font-bold">等待房主開始遊戲...</p>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoom, myName, currentType;

        function showAction(type) {
            currentType = type;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('action-panel').classList.remove('hidden');
            if(type === 'join') document.getElementById('roomIdInput').classList.remove('hidden');
            
            document.getElementById('confirm-btn').onclick = () => {
                myName = document.getElementById('username').value;
                if(!myName) return alert("請輸入暱稱");
                if(type === 'create') {
                    socket.emit('create_room');
                } else {
                    myRoom = document.getElementById('roomIdInput').value;
                    socket.emit('join_room', { roomId: myRoom, username: myName });
                }
            };
        }

        socket.on('room_created', (data) => {
            myRoom = data.roomId;
            socket.emit('join_room', { roomId: myRoom, username: myName });
        });

        socket.on('room_update', (data) => {
            document.getElementById('action-panel').classList.add('hidden');
            document.getElementById('lobby-zone').classList.remove('hidden');
            document.getElementById('room-display').innerText = "房號：" + data.roomId;

            // 判斷房主權限
            const isHost = (socket.id === data.hostId);
            document.getElementById('host-controls').classList.toggle('hidden', !isHost);
            document.getElementById('wait-msg').classList.toggle('hidden', isHost);

            // 更新玩家名單與星星 ⭐
            document.getElementById('player-list').innerHTML = data.players.map(p => {
                const star = (p.id === data.hostId) ? '⭐ ' : '';
                return `<span class="player-tag">${star}${p.name}</span>`;
            }).join('');
        });

        function startGame(mode) {
            socket.emit('start_game_with_config', {
                roomId: myRoom,
                gameType: mode,
                config: { winLines: 3, timeLimit: 60 }
            });
        }

        socket.on('game_begin', (data) => {
            alert("遊戲開始：" + data.gameType);
            // 這裡後續可以導向各個遊戲的畫面
        });

        socket.on('error_msg', msg => alert(msg));
    </script>
</body>
</html>
