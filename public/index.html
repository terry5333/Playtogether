<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morandi æ´¾å°ç›’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .bingo-cell { aspect-ratio: 1/1; cursor: pointer; transition: 0.2s; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 p-4 font-sans flex flex-col items-center">

    <div id="lobby" class="w-full max-w-sm mt-10 space-y-4">
        <h1 class="text-4xl font-black text-center text-slate-700 mb-8 tracking-tighter">PARTY BOX</h1>
        <input type="text" id="username" placeholder="ç©å®¶æš±ç¨±" class="w-full p-4 rounded-2xl bg-white shadow-sm ring-2 ring-transparent focus:ring-blue-400 outline-none">
        <input type="text" id="roomId" placeholder="æˆ¿è™Ÿ" class="w-full p-4 rounded-2xl bg-white shadow-sm ring-2 ring-transparent focus:ring-blue-400 outline-none">
        <select id="gameSelect" class="w-full p-4 rounded-2xl bg-white shadow-sm outline-none">
            <option value="bingo">è³“æœé€£é€£çœ‹</option>
            <option value="draw">ä½ ç•«æˆ‘çŒœ</option>
            <option value="spy">èª°æ˜¯è‡¥åº•</option>
        </select>
        <button onclick="join()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black shadow-lg active:scale-95 transition">é–‹å§‹</button>
    </div>

    <div id="game-area" class="hidden w-full max-w-md space-y-4 pt-6">
        <div class="flex justify-between items-center">
            <h2 id="turn-status" class="text-xl font-black text-slate-600">ç­‰å¾…é–‹å±€...</h2>
            <div id="player-tags" class="flex gap-1"></div>
        </div>

        <div id="bingo-ui" class="hidden">
            <div id="bingo-grid" class="grid grid-cols-5 gap-2 bg-white p-2 rounded-3xl shadow-xl border-4 border-white"></div>
        </div>

        <div id="draw-ui" class="hidden space-y-4">
            <canvas id="canvas" width="400" height="400" class="w-full bg-white rounded-3xl shadow-xl border-4 border-white touch-none"></canvas>
            <p id="draw-word" class="text-center font-bold text-blue-500"></p>
        </div>

        <div id="spy-ui" class="hidden space-y-6">
            <div onclick="toggleSpyCard()" class="bg-white p-16 rounded-[3rem] shadow-xl text-center border-b-[12px] border-blue-500 cursor-pointer active:scale-95 transition-all">
                <p class="text-[10px] font-bold text-slate-300 mb-2">é»æ“ŠæŸ¥çœ‹èº«åˆ†</p>
                <div id="spy-word" class="text-4xl font-black text-slate-800">ï¼Ÿ ï¼Ÿ ï¼Ÿ</div>
            </div>
            <div id="vote-list" class="grid grid-cols-2 gap-2"></div>
        </div>

        <button id="host-btn" onclick="startGame()" class="hidden w-full bg-orange-500 text-white p-5 rounded-3xl font-black shadow-xl">æˆ¿é•·é–‹å±€</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curRoom = "", isMyTurn = false, myType = "", mySpyWord = "", players = [];

        function join() {
            const data = { username: document.getElementById('username').value, roomId: document.getElementById('roomId').value, gameType: document.getElementById('gameSelect').value };
            curRoom = data.roomId; myType = data.gameType;
            socket.emit('join_room', data);
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById(`${myType}-ui`).classList.remove('hidden');
            if(myType === 'bingo') initBingo();
            if(myType === 'draw') initDraw();
        }

        socket.on('room_update', (room) => {
            players = room.players;
            if(socket.id === room.host && !room.gameStarted) document.getElementById('host-btn').classList.remove('hidden');
            document.getElementById('player-tags').innerHTML = room.players.map(p => `<span class="px-2 py-1 bg-white text-[10px] rounded-full border border-slate-200">${p.name}</span>`).join('');
        });

        function startGame() { socket.emit('start_game', { roomId: curRoom }); document.getElementById('host-btn').classList.add('hidden'); }

        socket.on('game_begin', (data) => { if(data.turnId) updateTurn(data.turnId); });
        function updateTurn(id) { isMyTurn = (socket.id === id); document.getElementById('turn-status').innerText = isMyTurn ? "ğŸ”´ ä½ çš„å›åˆ" : "âŒ› ç­‰å¾…ä¸­"; }

        // --- è³“æœé‚è¼¯ ---
        function initBingo() {
            const grid = document.getElementById('bingo-grid');
            grid.innerHTML = "";
            const nums = Array.from({length: 25}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            nums.forEach(n => {
                const cell = document.createElement('div');
                cell.className = "bingo-cell bg-slate-100 flex items-center justify-center font-bold rounded-xl text-lg";
                cell.innerText = n; cell.id = `cell-${n}`;
                cell.onclick = () => { if(isMyTurn) socket.emit('bingo_click', { roomId: curRoom, num: n }); };
                grid.appendChild(cell);
            });
        }
        socket.on('bingo_sync', (num) => { document.getElementById(`cell-${num}`).classList.add('bg-orange-500', 'text-white', 'scale-90'); });
        socket.on('next_turn', (data) => updateTurn(data.turnId));

        // --- èª°æ˜¯è‡¥åº•é‚è¼¯ ---
        socket.on('spy_setup', (data) => { 
            mySpyWord = data.word; 
            const list = document.getElementById('vote-list');
            list.innerHTML = players.map(p => `<button onclick="vote('${p.id}')" class="bg-white p-3 rounded-xl text-xs font-bold shadow-sm border border-slate-100">æŠ• ${p.name}</button>`).join('');
        });
        function toggleSpyCard() { const el = document.getElementById('spy-word'); el.innerText = el.innerText === "ï¼Ÿ ï¼Ÿ ï¼Ÿ" ? mySpyWord : "ï¼Ÿ ï¼Ÿ ï¼Ÿ"; el.classList.toggle('text-blue-600'); }
        function vote(id) { socket.emit('cast_vote', { roomId: curRoom, targetId: id }); alert("å·²æŠ•ç¥¨ï¼"); }
        socket.on('vote_result', (data) => alert("æŠ•ç¥¨çµæŸï¼çµæœå·²åœ¨ä¼ºæœå™¨çµç®—ã€‚"));

        // --- ä½ ç•«æˆ‘çŒœé‚è¼¯ (ç°¡åŒ–ç¹ªåœ–ä»£ç¢¼) ---
        let ctx;
        function initDraw() {
            const canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d'); ctx.lineWidth = 3;
            canvas.onmousemove = (e) => {
                if(!isMyTurn || e.buttons !== 1) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                ctx.lineTo(x, y); ctx.stroke();
                socket.emit('drawing', { roomId: curRoom, x, y, type: 'line' });
            };
            canvas.onmousedown = () => { ctx.beginPath(); socket.emit('drawing', { roomId: curRoom, type: 'start' }); };
        }
        socket.on('drawing', (d) => { if(d.type === 'start') ctx.beginPath(); else ctx.lineTo(d.x, d.y); ctx.stroke(); });
        socket.on('your_word', (d) => { document.getElementById('draw-word').innerText = "ä½ çš„é¡Œç›®ï¼š"+d.word; alert("ä½ æ˜¯ç•«å®¶ï¼é¡Œç›®ï¼š"+d.word); });
        socket.on('force_disconnect', (msg) => { alert(msg); location.reload(); });
    </script>
</body>
</html>
