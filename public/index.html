<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX 旗艦版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        canvas { background: white; border-radius: 1.5rem; touch-action: none; cursor: crosshair; }
        .bingo-cell { aspect-ratio: 1/1; background: #1e293b; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        .marked { background: #ef4444 !important; color: white; }
    </style>
</head>
<body class="p-4">

    <main id="main-menu" class="max-w-md mx-auto space-y-4 pt-20">
        <h1 class="text-5xl font-black text-center mb-10 tracking-tighter italic">PARTY<span class="text-blue-500">BOX.</span></h1>
        <div onclick="showAction('create')" class="glass p-8 rounded-[2rem] cursor-pointer hover:bg-slate-800 transition border-l-8 border-blue-500">
            <h2 class="text-2xl font-black text-white">創建房間</h2>
            <p class="text-slate-400 text-sm">身為房主開啟新局</p>
        </div>
        <div onclick="showAction('join')" class="glass p-8 rounded-[2rem] cursor-pointer hover:bg-slate-800 transition border-l-8 border-orange-500">
            <h2 class="text-2xl font-black text-white">加入房間</h2>
            <p class="text-slate-400 text-sm">輸入房號立即連線</p>
        </div>
    </main>

    <section id="action-panel" class="hidden max-w-md mx-auto space-y-4 pt-20">
        <input type="text" id="username" placeholder="輸入暱稱" class="w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-blue-500">
        <input type="text" id="roomIdInput" placeholder="輸入 4 位數房號" class="hidden w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-orange-500">
        <button id="confirm-btn" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-lg shadow-xl">進入大廳</button>
        <button onclick="location.reload()" class="w-full text-slate-500 font-bold">返回</button>
    </section>

    <section id="lobby-zone" class="hidden max-w-md mx-auto space-y-4">
        <div class="glass p-6 rounded-[2.5rem] space-y-6">
            <div class="flex justify-between items-center font-black">
                <span id="room-id-tag" class="text-blue-500 text-xl">房號：----</span>
                <span id="score-tag" class="text-orange-400">得分：0</span>
            </div>
            
            <div id="player-list" class="flex flex-wrap gap-2 justify-center"></div>

            <div id="host-controls" class="hidden border-t border-slate-700 pt-6 space-y-3">
                <p class="text-center text-[10px] font-black uppercase text-slate-500 tracking-widest">房主專屬選單</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="openConfig('bingo')" class="bg-slate-800 p-4 rounded-2xl font-bold hover:bg-slate-700 border-l-4 border-blue-500 text-left">賓果連連看</button>
                    <button onclick="openConfig('spy')" class="bg-slate-800 p-4 rounded-2xl font-bold hover:bg-slate-700 border-l-4 border-green-500 text-left">誰是臥底</button>
                    <button onclick="openConfig('draw')" class="bg-slate-800 p-4 rounded-2xl font-bold hover:bg-slate-700 border-l-4 border-orange-500 text-left">你畫我猜</button>
                </div>
            </div>
            
            <p id="wait-msg" class="text-center text-slate-500 animate-pulse py-4 font-bold">等待房主選擇模式...</p>
        </div>

        <div class="glass p-5 rounded-[2.5rem] space-y-4">
            <div id="chat-content" class="h-32 overflow-y-auto text-sm space-y-1 p-2 bg-slate-900/50 rounded-xl"></div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="聊天或猜題..." class="flex-1 bg-slate-800 p-3 rounded-xl outline-none text-xs">
                <button onclick="sendChat()" class="bg-blue-600 px-4 rounded-xl font-black text-xs">發送</button>
            </div>
        </div>
    </section>

    <section id="config-modal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="glass p-8 rounded-[3rem] w-full max-w-sm space-y-6 border border-white/20">
            <h2 id="config-title" class="text-2xl font-black text-center text-blue-400">遊戲設定</h2>
            <div id="opt-bingo" class="hidden"><label class="text-xs text-slate-400 font-bold">幾條線獲勝？</label><input type="number" id="winLines" value="3" class="w-full bg-slate-900 p-4 rounded-2xl mt-1 outline-none border border-slate-700 focus:border-blue-500"></div>
            <div id="opt-spy" class="hidden"><label class="text-xs text-slate-400 font-bold">討論時間(秒)</label><input type="number" id="spyTime" value="60" class="w-full bg-slate-900 p-4 rounded-2xl mt-1 outline-none border border-slate-700 focus:border-green-500"></div>
            <div id="opt-draw" class="hidden space-y-4">
                <div><label class="text-xs text-slate-400 font-bold">總回合數</label><input type="number" id="rounds" value="3" class="w-full bg-slate-900 p-4 rounded-2xl mt-1 outline-none border border-slate-700 focus:border-orange-500"></div>
                <div><label class="text-xs text-slate-400 font-bold">單人猜題限時(秒)</label><input type="number" id="drawLimit" value="180" class="w-full bg-slate-900 p-4 rounded-2xl mt-1 outline-none border border-slate-700 focus:border-orange-500"></div>
            </div>
            <button onclick="confirmStart()" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-lg">確定並開始</button>
            <button onclick="closeConfig()" class="w-full text-slate-500 text-xs font-bold">取消返回</button>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoom, myName, currentAction, selectedGame, myWord, fillIdx=1, myBoard=Array(25).fill(0);

        function showAction(type) {
            currentAction = type;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('action-panel').classList.remove('hidden');
            document.getElementById('roomIdInput').classList.toggle('hidden', type==='create');
            document.getElementById('confirm-btn').onclick = type==='create' ? () => socket.emit('create_room') : joinRoom;
        }

        socket.on('room_created', d => { 
            myRoom = d.roomId; 
            joinRoom(); 
        });

        function joinRoom() {
            myName = document.getElementById('username').value;
            const rid = currentAction === 'create' ? myRoom : document.getElementById('roomIdInput').value;
            if(!myName || !rid) return alert("請填寫暱稱與房號");
            myRoom = rid;
            socket.emit('join_room', { roomId: rid, username: myName });
            document.getElementById('action-panel').classList.add('hidden');
            document.getElementById('lobby-zone').classList.remove('hidden');
            document.getElementById('room-id-tag').innerText = "房號：" + rid;
        }

        // 重要修正：處理房主權限與玩家清單
        socket.on('room_update', d => {
            const isHost = socket.id === d.hostId;
            
            // 顯示/隱藏房主專屬選單
            const hostControls = document.getElementById('host-controls');
            const waitMsg = document.getElementById('wait-msg');
            
            if (isHost) {
                hostControls.classList.remove('hidden');
                waitMsg.classList.add('hidden');
            } else {
                hostControls.classList.add('hidden');
                waitMsg.classList.remove('hidden');
            }

            // 更新玩家清單，房主加星星 ⭐
            document.getElementById('player-list').innerHTML = d.players.map(p => {
                const isThisPlayerHost = p.id === d.hostId;
                return `<span class="bg-slate-800 px-3 py-1 rounded-xl text-[10px] border border-slate-700 font-bold">
                    ${isThisPlayerHost ? '⭐ ' : ''}${p.name}
                </span>`;
            }).join('');
        });

        function openConfig(type) {
            selectedGame = type;
            document.getElementById('config-modal').classList.remove('hidden');
            ['bingo','spy','draw'].forEach(g => document.getElementById('opt-'+g).classList.add('hidden'));
            document.getElementById('opt-'+type).classList.remove('hidden');
            
            const titles = { bingo: "賓果參數", spy: "臥底時間", draw: "猜題回合設定" };
            document.getElementById('config-title').innerText = titles[type];
        }

        function closeConfig() { document.getElementById('config-modal').classList.add('hidden'); }

        function confirmStart() {
            const config = { 
                winLines: document.getElementById('winLines').value, 
                spyTime: document.getElementById('spyTime').value, 
                rounds: document.getElementById('rounds').value, 
                drawLimit: document.getElementById('drawLimit').value 
            };
            socket.emit('start_game_with_config', { roomId: myRoom, gameType: selectedGame, config });
            closeConfig();
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            socket.emit('send_chat', { roomId: myRoom, user: myName, text: input.value });
            input.value = "";
        }

        socket.on('receive_chat', d => {
            const box = document.getElementById('chat-content');
            box.innerHTML += `<div><b class="text-blue-400">${d.user}:</b> <span class="text-slate-300">${d.text}</span></div>`;
            box.scrollTop = box.scrollHeight;
        });

        // 遊戲轉場與邏輯省略，同前一版...
    </script>
</body>
</html>
