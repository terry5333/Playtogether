<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayTogether - è‡¥åº•é€²éšç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #F2F0EB; color: #5F6368; }
        .morandi-card { background: white; border-radius: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .btn-blue { background-color: #A3B9C9; color: white; }
        .btn-green { background-color: #B4C4B8; color: white; }
        .timer-active { color: #E2B4B4; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md morandi-card p-8 border border-gray-100 mt-6">
        
        <div id="step-0" class="space-y-6 text-center">
            <h1 class="text-2xl font-light tracking-widest text-gray-400 mb-8">PLAY TOGETHER</h1>
            <div onclick="selectGame('spy')" class="p-6 border rounded-3xl cursor-pointer border-green-100"><h2 class="text-[#B4C4B8] font-bold">èª°æ˜¯è‡¥åº•</h2></div>
            <div onclick="selectGame('bingo')" class="p-6 border rounded-3xl cursor-pointer border-blue-100"><h2 class="text-[#A3B9C9] font-bold">ç¶“å…¸ BINGO</h2></div>
        </div>

        <div id="step-1" class="hidden text-center space-y-6">
            <input type="text" id="nameInp" class="w-full p-4 bg-gray-50 rounded-2xl text-center" placeholder="æš±ç¨±">
            <button onclick="toLobby()" class="w-full btn-blue py-4 rounded-2xl">ä¸‹ä¸€æ­¥</button>
        </div>

        <div id="step-2" class="hidden space-y-6">
            <input type="text" id="cRoomId" placeholder="æˆ¿è™Ÿ" class="w-full p-4 bg-gray-50 rounded-2xl text-center outline-none">
            <input type="number" id="cMaxP" value="3" class="w-full p-4 bg-gray-50 rounded-2xl text-center" title="äººæ•¸">
            <button onclick="join(true)" class="w-full btn-blue py-4 rounded-2xl">å»ºç«‹ä¸¦é€²å…¥</button>
            <button onclick="join(false)" class="w-full btn-green py-4 rounded-2xl">åŠ å…¥æˆ¿é–“</button>
        </div>

        <div id="step-4" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <div id="player-list" class="flex flex-wrap gap-1"></div>
                <div id="room-timer" class="text-xs text-gray-400">02:00</div>
            </div>
            
            <div id="spy-ui" class="hidden space-y-6">
                <div class="bg-gray-50 p-8 rounded-[2rem] text-center border-2 border-dashed border-gray-100">
                    <p class="text-[10px] text-gray-300 mb-2">ç¥•å¯†è©èª</p>
                    <h2 id="spy-word-display" class="text-3xl font-bold text-slate-500">????</h2>
                </div>

                <div id="vote-section" class="hidden space-y-4">
                    <h3 class="text-center text-xs font-bold text-red-300">æ™‚é–“åˆ°ï¼è«‹æŠ•ç¥¨æ‰¾å‡ºè‡¥åº•</h3>
                    <div id="vote-grid" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>

            <div id="bingo-ui" class="hidden">/* Bingo ä»‹é¢ç•¥ */</div>

            <button id="startBtn" onclick="sendStart()" class="hidden w-full btn-blue py-4 rounded-2xl mt-6">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let selectedGame = '', curRoom, isHost = false;

        function selectGame(g) { selectedGame = g; document.getElementById('step-0').classList.add('hidden'); document.getElementById('step-1').classList.remove('hidden'); }
        function toLobby() { document.getElementById('step-1').classList.add('hidden'); document.getElementById('step-2').classList.remove('hidden'); }
        function join(h) {
            isHost = h; curRoom = document.getElementById('cRoomId').value;
            socket.emit('join_room', { roomId: curRoom, username: document.getElementById('nameInp').value, gameType: selectedGame, maxPlayers: document.getElementById('cMaxP').value });
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-4').classList.remove('hidden');
            if(selectedGame==='spy') document.getElementById('spy-ui').classList.remove('hidden');
        }

        function sendStart() { socket.emit('start_game', curRoom); }

        socket.on('timer_update', (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            const el = document.getElementById('room-timer');
            el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(seconds <= 10) el.classList.add('timer-active'); else el.classList.remove('timer-active');
        });

        socket.on('force_vote', () => {
            document.getElementById('vote-section').classList.remove('hidden');
            document.getElementById('spy-word-display').parentElement.classList.add('opacity-30');
        });

        socket.on('receive_spy_word', (d) => {
            document.getElementById('spy-word-display').innerText = d.word;
            document.getElementById('startBtn').classList.add('hidden');
        });

        socket.on('room_update', (d) => {
            const list = document.getElementById('player-list');
            list.innerHTML = d.players.map(p => `<span class="px-3 py-1 bg-gray-50 text-[10px] rounded-full ${p.isAlive?'':'line-through opacity-30'}">${p.name}</span>`).join('');
            if(isHost && !d.gameStarted) document.getElementById('startBtn').classList.remove('hidden');
            
            const vGrid = document.getElementById('vote-grid');
            vGrid.innerHTML = d.players.filter(p => p.isAlive).map(p => 
                `<button onclick="castVote('${p.id}')" class="p-3 bg-white border border-red-200 text-red-400 rounded-xl text-xs hover:bg-red-50">${p.name}</button>`
            ).join('');
        });

        function castVote(tid) {
            socket.emit('cast_vote', { roomId: curRoom, targetId: tid });
            document.getElementById('vote-section').innerHTML = "<p class='text-center text-xs text-gray-300'>å·²æŠ•ç¥¨ï¼Œç­‰å¾…é–‹ç¥¨...</p>";
        }

        socket.on('vote_result', (d) => {
            const identity = d.isSpy ? "æ˜¯è‡¥åº•ï¼" : "æ˜¯å¹³æ°‘ï¼";
            alert(`æŠ•ç¥¨çµæœï¼š${d.kickedName} è¢«æŠ•å‡ºå»äº†ï¼Œä»–${identity}`);
            document.getElementById('vote-section').classList.add('hidden');
            document.getElementById('spy-word-display').parentElement.classList.remove('opacity-30');
            // é‡ç½®æŠ•ç¥¨å€ä¾›ä¸‹ä¸€è¼ªä½¿ç”¨
            document.getElementById('vote-section').innerHTML = `<h3 class="text-center text-xs font-bold text-red-300">æ™‚é–“åˆ°ï¼è«‹æŠ•ç¥¨æ‰¾å‡ºè‡¥åº•</h3><div id="vote-grid" class="grid grid-cols-2 gap-2"></div>`;
        });

        socket.on('game_over', (d) => {
            alert(`ğŸ† éŠæˆ²çµæŸï¼è´å®¶æ˜¯ï¼š${d.winner}`);
            location.reload();
        });
    </script>
</body>
</html>
