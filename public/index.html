<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayTogether - è‡ªå®šç¾© Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell-fill { transition: all 0.2s; }
        .cell-fill.active { border-color: #3b82f6; background-color: #eff6ff; }
        .marked { background-color: #3b82f6 !important; color: white; transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <div class="max-w-md mx-auto px-4 py-8">
        <div id="name-panel" class="bg-white rounded-2xl shadow-xl p-6 text-center">
            <h2 class="text-2xl font-bold mb-4">æ­¡è¿ä¾†åˆ° Bingo!</h2>
            <input type="text" id="usernameInput" class="w-full p-3 border rounded-xl mb-4" placeholder="è¼¸å…¥ä½ çš„å¤§å">
            <button onclick="showLobby()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">ä¸‹ä¸€æ­¥</button>
        </div>

        <div id="lobby-panel" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-blue-500">
                <h3 class="font-bold mb-4 text-blue-600">å‰µå»ºæˆ¿é–“</h3>
                <input type="text" id="createRoomId" placeholder="æˆ¿é–“ä»£ç¢¼" class="w-full p-2 border rounded-lg mb-2">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="number" id="winLines" value="3" placeholder="å‹åˆ©ç·šæ•¸" class="p-2 border rounded-lg text-sm">
                    <button onclick="handleJoin(true)" class="bg-blue-500 text-white rounded-lg font-bold">å‰µå»º</button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-emerald-500">
                <h3 class="font-bold mb-4 text-emerald-600">åŠ å…¥æˆ¿é–“</h3>
                <input type="text" id="joinRoomId" placeholder="è¼¸å…¥æˆ¿é–“ä»£ç¢¼" class="w-full p-2 border rounded-lg mb-2">
                <button onclick="handleJoin(false)" class="w-full bg-emerald-500 text-white py-2 rounded-lg font-bold">é€²å…¥</button>
            </div>
        </div>

        <div id="fill-panel" class="hidden">
            <div class="bg-blue-50 p-4 rounded-xl mb-4 text-center">
                <p class="font-bold text-blue-700">è«‹ä¾åºå¡«å…¥ 1~25</p>
                <p class="text-xs text-blue-500">é»æ“Šç©ºæ ¼å¡«å…¥ä¸‹ä¸€å€‹æ•¸å­—</p>
            </div>
            <div id="fillGrid" class="grid grid-cols-5 gap-2 bg-white p-4 rounded-2xl shadow-xl"></div>
            <button id="startBtn" onclick="startGame()" class="w-full mt-4 bg-slate-400 text-white py-3 rounded-xl font-bold cursor-not-allowed" disabled>è«‹å…ˆå¡«æ»¿æ•¸å­—</button>
        </div>

        <div id="game-panel" class="hidden text-center">
            <div class="bg-white p-3 rounded-xl mb-4 shadow-sm flex justify-between items-center text-sm">
                <span id="display-name" class="font-bold text-blue-600"></span>
                <span id="line-badge" class="bg-red-500 text-white px-2 py-1 rounded-md font-bold">0 / 5 ç·š</span>
            </div>
            <div id="gameGrid" class="grid grid-cols-5 gap-2 bg-white p-4 rounded-2xl shadow-xl"></div>
            <p id="system-msg" class="mt-4 text-slate-500 text-sm italic"></p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "", currentRoom = "", targetLines = 5;
        let fillCount = 1;
        let myLayout = Array(25).fill(null);
        let boardState = Array(25).fill(false);
        let numToIdx = {};

        function showLobby() {
            myName = document.getElementById('usernameInput').value;
            if (!myName) return alert("è«‹è¼¸å…¥å§“å");
            document.getElementById('name-panel').classList.add('hidden');
            document.getElementById('lobby-panel').classList.remove('hidden');
        }

        function handleJoin(isCreator) {
            const rid = isCreator ? document.getElementById('createRoomId').value : document.getElementById('joinRoomId').value;
            if (!rid) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
            currentRoom = rid;
            if (isCreator) targetLines = parseInt(document.getElementById('winLines').value);
            
            socket.emit('join_room', { roomId: rid, username: myName, winLines: targetLines });
            
            document.getElementById('lobby-panel').classList.add('hidden');
            initFillGrid();
        }

        function initFillGrid() {
            document.getElementById('fill-panel').classList.remove('hidden');
            const grid = document.getElementById('fillGrid');
            for (let i = 0; i < 25; i++) {
                const btn = document.createElement('button');
                btn.className = "cell-fill aspect-square border-2 border-dashed rounded-lg text-lg font-bold text-slate-300";
                btn.onclick = () => fillCell(i, btn);
                grid.appendChild(btn);
            }
        }

        function fillCell(idx, btn) {
            if (myLayout[idx] !== null) return;
            myLayout[idx] = fillCount;
            numToIdx[fillCount] = idx;
            btn.innerText = fillCount;
            btn.className = "aspect-square border-2 border-blue-500 bg-blue-50 text-blue-600 rounded-lg text-lg font-bold";
            fillCount++;
            if (fillCount > 25) {
                const sBtn = document.getElementById('startBtn');
                sBtn.disabled = false;
                sBtn.className = "w-full mt-4 bg-blue-600 text-white py-3 rounded-xl font-bold transition-all hover:bg-blue-700 shadow-lg";
            }
        }

        function startGame() {
            document.getElementById('fill-panel').classList.add('hidden');
            document.getElementById('game-panel').classList.remove('hidden');
            document.getElementById('display-name').innerText = `ç©å®¶: ${myName}`;
            
            const grid = document.getElementById('gameGrid');
            myLayout.forEach((num, idx) => {
                const btn = document.createElement('button');
                btn.className = "aspect-square bg-slate-100 rounded-lg text-lg font-bold border-b-4 border-slate-300 active:border-b-0";
                btn.innerText = num;
                btn.id = `game-idx-${idx}`;
                btn.onclick = () => {
                    socket.emit('game_move', { roomId: currentRoom, number: num });
                    markNumber(num);
                };
                grid.appendChild(btn);
            });
        }

        function markNumber(num) {
            const idx = numToIdx[num];
            if (idx !== undefined && !boardState[idx]) {
                boardState[idx] = true;
                const el = document.getElementById(`game-idx-${idx}`);
                el.classList.add('marked');
                el.disabled = true;
                checkWin();
            }
        }

        function checkWin() {
            let lines = 0;
            for (let i = 0; i < 5; i++) {
                if ([0,1,2,3,4].every(j => boardState[i*5 + j])) lines++;
                if ([0,1,2,3,4].every(j => boardState[j*5 + i])) lines++;
            }
            if ([0,6,12,18,24].every(i => boardState[i])) lines++;
            if ([4,8,12,16,20].every(i => boardState[i])) lines++;

            document.getElementById('line-badge').innerText = `${lines} / ${targetLines} ç·š`;
            if (lines >= targetLines) {
                alert(`ğŸŠ BINGO! ${myName} ç²å‹ï¼`);
            }
        }

        socket.on('receive_move', (data) => {
            markNumber(data.number);
            document.getElementById('system-msg').innerText = `${data.senderName} å–Šäº† ${data.number}`;
        });
    </script>
</body>
</html>
