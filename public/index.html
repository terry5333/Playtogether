<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Party Box</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bingo-cell { aspect-ratio: 1/1; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
        .filled { background: #e0f2fe; color: #0369a1; }
        .marked { background: #ef4444 !important; color: white !important; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 bg-gray-50 flex flex-col items-center">

    <div id="lobby" class="mt-20 space-y-4">
        <input type="text" id="username" placeholder="名字" class="border p-2 w-64 block">
        <input type="text" id="roomId" placeholder="房號" class="border p-2 w-64 block">
        <button onclick="join()" class="bg-blue-500 text-white p-2 w-64">進入房間</button>
    </div>

    <div id="game-area" class="hidden w-full max-w-sm">
        <div id="host-panel" class="hidden border p-4 mb-4 bg-white">
            <p class="font-bold mb-2">房長設定</p>
            <select id="gameType" onchange="changeSet()" class="border w-full p-2 mb-2">
                <option value="bingo">賓果</option>
                <option value="draw">你畫我猜</option>
                <option value="spy">誰是臥底</option>
            </select>
            <div id="bingo-set">幾條線勝利？ <input type="number" id="winLines" value="3" class="border w-16"></div>
            <div id="draw-set" class="hidden">幾回合遊戲？ <input type="number" id="rounds" value="3" class="border w-16"></div>
            <div id="spy-set" class="hidden">倒數幾秒？ <input type="number" id="spyTime" value="60" class="border w-16"></div>
            <button onclick="sendStart()" class="bg-orange-500 text-white w-full p-2 mt-2">開始遊戲</button>
        </div>

        <h2 id="status" class="text-center font-bold mb-4">準備中...</h2>

        <div id="ui-bingo" class="hidden">
            <p id="bingo-hint" class="text-center text-blue-500 mb-2">請按順序點擊格子填入 1-25</p>
            <div id="bingo-grid" class="grid grid-cols-5 gap-1 bg-white p-1 shadow"></div>
        </div>

        <div id="ui-spy" class="hidden space-y-4">
            <div id="timer" class="text-center text-2xl text-red-500 font-bold">60s</div>
            <div id="spy-card" onclick="this.innerText=myWord" class="h-40 bg-white border-2 border-dashed flex items-center justify-center text-xl font-bold cursor-pointer">點擊看詞</div>
            <div id="vote-area" class="hidden border-t pt-4">
                <p class="text-center font-bold mb-2">時間到！請投票</p>
                <div id="vote-btns" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoom, myName, isHost = false, myWord = "";
        let fillIdx = 1, myBoard = Array(25).fill(0);

        function join() {
            myName = document.getElementById('username').value;
            myRoom = document.getElementById('roomId').value;
            socket.emit('join_room', { roomId: myRoom, username: myName });
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
        }

        socket.on('room_update', (room) => {
            isHost = (socket.id === room.host);
            if(isHost && !room.gameStarted) document.getElementById('host-panel').classList.remove('hidden');
            // 更新投票列表用的玩家清單
            window.allPlayers = room.players;
        });

        function changeSet() {
            const type = document.getElementById('gameType').value;
            document.getElementById('bingo-set').classList.toggle('hidden', type !== 'bingo');
            document.getElementById('draw-set').classList.toggle('hidden', type !== 'draw');
            document.getElementById('spy-set').classList.toggle('hidden', type !== 'spy');
        }

        function sendStart() {
            const type = document.getElementById('gameType').value;
            const settings = {
                winLines: document.getElementById('winLines').value,
                rounds: document.getElementById('rounds').value,
                spyTime: document.getElementById('spyTime').value
            };
            socket.emit('start_game', { roomId: myRoom, gameType: type, settings });
        }

        socket.on('game_begin', (data) => {
            document.getElementById('host-panel').classList.add('hidden');
            document.getElementById('ui-bingo').classList.toggle('hidden', data.gameType !== 'bingo');
            document.getElementById('ui-spy').classList.toggle('hidden', data.gameType !== 'spy');
            if(data.gameType === 'bingo') initBingo();
        });

        // 痛點 2：手動點選填號碼
        function initBingo() {
            const grid = document.getElementById('bingo-grid'); grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = "bingo-cell bg-gray-50";
                cell.onclick = () => {
                    if(fillIdx <= 25) {
                        if(myBoard[i] !== 0) return;
                        myBoard[i] = fillIdx;
                        cell.innerText = fillIdx;
                        cell.classList.add('filled');
                        fillIdx++;
                        if(fillIdx > 25) document.getElementById('bingo-hint').innerText = "填寫完成，等待開球";
                    } else {
                        socket.emit('bingo_click', { roomId: myRoom, num: myBoard[i] });
                    }
                };
                grid.appendChild(cell);
            }
        }

        socket.on('bingo_sync', (num) => {
            const idx = myBoard.indexOf(num);
            if(idx !== -1) document.getElementById('bingo-grid').children[idx].classList.add('marked');
        });

        // 誰是臥底強制投票
        socket.on('timer_sync', (s) => document.getElementById('timer').innerText = s + "s");
        socket.on('spy_force_vote', () => {
            document.getElementById('vote-area').classList.remove('hidden');
            const btnArea = document.getElementById('vote-btns');
            btnArea.innerHTML = window.allPlayers.map(p => `<button class="border p-2 text-sm">${p.name}</button>`).join('');
        });
    </script>
</body>
</html>
