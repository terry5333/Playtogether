<section id="view-bingo" class="hidden max-w-md mx-auto space-y-4">
    <div class="glass p-6 rounded-3xl">
        <div id="bingo-status-bar" class="text-center mb-4 py-2 bg-blue-900/30 rounded-xl text-sm font-bold text-blue-300">
            ç­‰å¾…æ‰€æœ‰äººå¡«å¯«...
        </div>
        <div id="bingo-board" class="bingo-grid mb-6"></div>
        
        <div id="bingo-pad" class="num-pad"></div>

        <div id="bingo-pick-zone" class="hidden space-y-4">
            <p class="text-xs text-center text-slate-400">é»æ“Šä¸Šæ–¹ä½ å¡ç‰Œä¸Šçš„æ•¸å­—ä¾†é–‹è™Ÿ</p>
            <div id="bingo-controls" class="hidden">
                <button id="btn-host-start-bingo" onclick="hostStartBingo()" class="w-full bg-orange-600 p-3 rounded-xl font-bold">å…¨å“¡åˆ°é½Šï¼Œé–‹å§‹è¼ªæµé¸è™Ÿ</button>
            </div>
        </div>
    </div>
</section>

<div id="spy-vote-ui" class="hidden space-y-4 border-t border-white/10 pt-4">
    <p class="text-orange-400 font-bold">è¨è«–çµæŸï¼è«‹æŠ•çµ¦å¯ç–‘çš„äººï¼š</p>
    <div id="spy-vote-list" class="grid grid-cols-2 gap-2"></div>
</div>

<script>
    let isMyTurn = false;
    let pickedNumbers = [];

    // 1. è³“æœå¡«å¯«å®Œæˆ
    function bingoFinish() {
        document.getElementById('bingo-pad').classList.add('hidden');
        document.getElementById('bingo-pick-zone').classList.remove('hidden');
        document.getElementById('bingo-status-bar').innerText = "å¡«å¯«å®Œæˆï¼Œç­‰å¾…æˆ¿ä¸»é–‹å±€...";
        socket.emit('bingo_ready', { roomId: myRoom });
        
        // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œé¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
        if(isHost) document.getElementById('bingo-controls').classList.remove('hidden');
    }

    function hostStartBingo() {
        socket.emit('bingo_start_picking', { roomId: myRoom });
        document.getElementById('bingo-controls').classList.add('hidden');
    }

    // 2. è³“æœè¼ªæµé¸è™Ÿé‚è¼¯
    socket.on('bingo_next_turn', d => {
        isMyTurn = (socket.id === d.activePlayerId);
        document.getElementById('bingo-status-bar').innerText = isMyTurn ? "ğŸŒŸ è¼ªåˆ°ä½ é¸è™Ÿäº†ï¼" : `ç­‰å¾… ${d.activePlayerName} é¸è™Ÿ...`;
        document.getElementById('bingo-status-bar').classList.toggle('bg-orange-500', isMyTurn);
    });

    // é»æ“Šå¡ç‰Œæ ¼å­é–‹è™Ÿ
    function handleCellClick(idx) {
        const num = bData[idx];
        if (!num || !isMyTurn || pickedNumbers.includes(num)) return;
        
        socket.emit('bingo_pick_number', { roomId: myRoom, number: num });
    }

    socket.on('bingo_number_announced', d => {
        pickedNumbers.push(d.number);
        // æ›´æ–°å¡ç‰Œè¦–è¦º (è®Šè‰²)
        const cells = document.querySelectorAll('.bingo-cell');
        cells.forEach(cell => {
            if (parseInt(cell.innerText) === d.number) {
                cell.classList.add('bg-green-600', 'border-white');
                cell.classList.remove('bg-slate-800');
            }
        });
        alert(`${d.pickerName} é¸äº†ï¼š${d.number}`);
    });

    // 3. ä½ è©±æˆ‘çŒœï¼šä¿®å¾©å‡ºé¡Œè½‰å ´
    socket.on('draw_guessing_stage', d => {
        v('view-draw');
        document.getElementById('draw-msg').innerText = `ç•«å®¶ï¼š${d.drawerName}`;
        if(socket.username !== d.drawerName) {
            document.getElementById('draw-guesser-ui').classList.remove('hidden');
            document.getElementById('draw-status-box').innerText = "æ­£åœ¨ç•«ç•«ä¸­... å¿«çŒœï¼";
        } else {
            document.getElementById('draw-drawer-ui').innerHTML = `<div class="p-10 text-xl font-bold">å‡ºé¡ŒæˆåŠŸï¼è«‹é–‹å§‹ç•«ç•«</div>`;
        }
    });

    // 4. èª°æ˜¯è‡¥åº•ï¼šæŠ•ç¥¨å•Ÿå‹•
    // ç•¶è¨ˆæ™‚å™¨æ­¸é›¶æ™‚
    function onSpyTimerEnd() {
        socket.emit('start_spy_vote', { roomId: myRoom });
    }

    socket.on('spy_vote_begin', d => {
        const voteUI = document.getElementById('spy-vote-ui');
        voteUI.classList.remove('hidden');
        const list = document.getElementById('spy-vote-list');
        list.innerHTML = d.players.map(p => `
            <button onclick="castVote('${p.name}')" class="bg-slate-800 p-3 rounded-xl border border-slate-700">${p.name}</button>
        `).join('');
    });

    function castVote(name) {
        socket.emit('cast_spy_vote', { roomId: myRoom, targetName: name });
        document.getElementById('spy-vote-ui').innerHTML = "<p class='py-4'>æŠ•ç¥¨å®Œæˆï¼Œç­‰å¾…çµæœ...</p>";
    }
</script>
