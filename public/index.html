<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Game Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --blue: #A3B9C9; --green: #2F4F4F; --bg: #F2F0EB; }
        body { background-color: var(--bg); color: var(--green); touch-action: none; overflow: hidden; font-family: sans-serif; }
        .morandi-card { background: white; border-radius: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .bingo-cell { aspect-ratio: 1/1; border: 1px solid #eee; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #fff; cursor: pointer; }
        .cell-marked { background-color: var(--green) !important; color: white !important; }
        #canvas { background: white; border-radius: 1rem; width: 100%; height: 350px; border: 1px solid #ddd; touch-action: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="login-panel" class="w-full max-w-sm morandi-card p-8 space-y-6">
        <h1 class="text-2xl font-black text-center text-[#2F4F4F]">GAME HUB</h1>
        <div class="space-y-3">
            <input type="text" id="nameInp" placeholder="æ‚¨çš„æš±ç¨±" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent focus:border-[#A3B9C9]">
            <input type="text" id="roomInp" placeholder="æˆ¿é–“è™Ÿç¢¼" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent focus:border-[#A3B9C9]">
        </div>
        <div class="grid gap-3">
            <button onclick="confirmJoin('bingo')" class="p-4 bg-[#A3B9C9] text-white rounded-2xl font-bold hover:opacity-90">ğŸ”¢ è³“æœ (Bingo)</button>
            <button onclick="confirmJoin('draw')" class="p-4 bg-[#2F4F4F] text-white rounded-2xl font-bold hover:opacity-90">ğŸ¨ ä½ ç•«æˆ‘çŒœ</button>
            <button onclick="confirmJoin('spy')" class="p-4 border-2 border-[#2F4F4F] rounded-2xl font-bold hover:bg-gray-50">ğŸ•µï¸ èª°æ˜¯è‡¥åº•</button>
        </div>
    </div>

    <div id="game-panel" class="hidden w-full max-w-md morandi-card p-6 flex flex-col relative" style="height: 94vh;">
        <div class="flex justify-between items-center mb-4">
            <div id="status-tag" class="px-3 py-1 rounded-full bg-[#2F4F4F] text-white text-[10px] font-bold">ç­‰å¾…ç©å®¶...</div>
            <div id="room-display" class="text-[10px] text-gray-400 font-mono"></div>
        </div>

        <div id="player-list" class="flex gap-2 mb-4 overflow-x-auto py-2"></div>

        <div class="flex-1 overflow-y-auto">
            
            <div id="bingo-area" class="hidden space-y-4">
                <div id="bingo-grid" class="grid grid-cols-5 gap-2"></div>
                <button onclick="bingoAutoFill()" class="w-full py-2 text-xs text-blue-500 bg-blue-50 rounded-xl">ğŸ² éš¨æ©Ÿå¡«å¯« 1-25</button>
            </div>

            <div id="draw-area" class="hidden space-y-4">
                <canvas id="canvas" width="600" height="600"></canvas>
                <div class="text-center text-xs text-gray-400">è¼ªåˆ°ä½ æ™‚å³å¯åœ¨ä¸Šæ–¹ç¹ªåœ–</div>
            </div>

            <div id="spy-area" class="hidden"></div>

        </div>

        <div id="controls-area" class="mt-4 space-y-3">
            <div id="bingo-settings" class="hidden flex items-center justify-between bg-gray-100 p-3 rounded-2xl">
                <span class="text-xs font-bold">é”æˆç·šæ•¸ï¼š</span>
                <select id="winLinesSelect" class="bg-white rounded px-2 py-1 text-xs outline-none">
                    <option value="1">1 æ¢ç·š</option>
                    <option value="2">2 æ¢ç·š</option>
                    <option value="3" selected>3 æ¢ç·š</option>
                    <option value="5">5 æ¢ç·š</option>
                </select>
            </div>
            
            <button id="startBtn" onclick="sendStart()" class="hidden w-full p-4 bg-[#2F4F4F] text-white rounded-2xl font-bold shadow-lg">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, curRoom, myGame, isHost = false, isTurn = false, winTarget = 3;
        let currentPlayers = [];

        function confirmJoin(game) {
            myName = document.getElementById('nameInp').value;
            curRoom = document.getElementById('roomInp').value;
            if(!myName || !curRoom) return alert("è«‹è¼¸å…¥æš±ç¨±èˆ‡æˆ¿è™Ÿ");
            
            myGame = game;
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('game-panel').classList.remove('hidden');
            document.getElementById('room-display').innerText = `ROOM: ${curRoom}`;

            // é¡¯ç¤ºå°æ‡‰éŠæˆ²å€åŸŸ
            if(game === 'bingo') {
                document.getElementById('bingo-area').classList.remove('hidden');
                initBingoBoard(); 
            } else if(game === 'draw') {
                document.getElementById('draw-area').classList.remove('hidden');
                initDraw();
            } else if(game === 'spy') {
                document.getElementById('spy-area').classList.remove('hidden');
                // spy.js æœƒè‡ªå‹•è™•ç† init
            }

            socket.emit('join_room', { roomId: curRoom, username: myName, gameType: game });
        }

        // æˆ¿ä¸»ç™¼é€é–‹å§‹æŒ‡ä»¤
        function sendStart() {
            const lines = document.getElementById('winLinesSelect').value;
            socket.emit('start_game', { roomId: curRoom, winLines: lines });
        }

        // ç›£è½æˆ¿é–“ç‹€æ…‹æ›´æ–°
        socket.on('room_update', (room) => {
            currentPlayers = room.players;
            isHost = (socket.id === room.host);
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨ UI
            const listEl = document.getElementById('player-list');
            listEl.innerHTML = room.players.map(p => `
                <div class="px-3 py-1 bg-white border rounded-full text-[10px] whitespace-nowrap shadow-sm">
                    ${p.id === room.host ? 'ğŸ‘‘ ' : ''}${p.name}
                </div>
            `).join('');

            // æˆ¿ä¸»æ§åˆ¶é¢æ¿
            if(isHost && !room.gameStarted) {
                document.getElementById('startBtn').classList.remove('hidden');
                if(myGame === 'bingo') {
                    document.getElementById('bingo-settings').classList.remove('hidden');
                }
            }
        });

        // ç›£è½éŠæˆ²æ­£å¼é–‹å§‹
        socket.on('game_begin', (data) => {
            winTarget = data.winLines;
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('bingo-settings').classList.add('hidden');
            updateTurnStatus(data.turnId, data.turnName);
        });

        // ç›£è½å›åˆåˆ‡æ›
        socket.on('next_turn', (data) => {
            updateTurnStatus(data.turnId, data.turnName);
        });

        function updateTurnStatus(tid, tname) {
            isTurn = (socket.id === tid);
            const tag = document.getElementById('status-tag');
            if(isTurn) {
                tag.innerText = "ğŸŒŸ è¼ªåˆ°ä½ äº†";
                tag.classList.replace('bg-[#2F4F4F]', 'bg-orange-400');
            } else {
                tag.innerText = `ç­‰å¾… ${tname || 'å°æ‰‹'}...`;
                tag.classList.replace('bg-orange-400', 'bg-[#2F4F4F]');
            }
        }

        // ç›£è½ 5 åˆ†é˜é–’ç½®é—œé–‰
        socket.on('room_closed', (data) => {
            alert(data.msg);
            window.location.reload();
        });
    </script>

    <script src="bingo.js"></script>
    <script src="draw.js"></script>
    <script src="spy.js"></script>
</body>
</html>
