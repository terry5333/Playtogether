<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTY BOX æ——è‰¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        canvas { background: white; border-radius: 20px; cursor: crosshair; touch-action: none; }
    </style>
</head>
<body class="p-6">

    <main id="main-menu" class="max-w-md mx-auto space-y-4 pt-20">
        <h1 class="text-5xl font-black text-center mb-10 tracking-tighter">PARTY<span class="text-blue-500">BOX.</span></h1>
        <div onclick="showAction('create')" class="glass-card p-8 rounded-[2rem] cursor-pointer hover:bg-slate-800 border-l-8 border-blue-500">
            <h2 class="text-2xl font-black">å‰µå»ºæˆ¿é–“</h2>
        </div>
        <div onclick="showAction('join')" class="glass-card p-8 rounded-[2rem] cursor-pointer hover:bg-slate-800 border-l-8 border-orange-500">
            <h2 class="text-2xl font-black">åŠ å…¥æˆ¿é–“</h2>
        </div>
    </main>

    <section id="action-panel" class="hidden max-w-md mx-auto space-y-4">
        <input type="text" id="username" placeholder="ä½ çš„æš±ç¨±" class="w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-blue-500">
        <input type="text" id="roomIdInput" placeholder="æˆ¿è™Ÿ" class="hidden w-full bg-slate-800 p-4 rounded-2xl outline-none">
        <button id="confirm-btn" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-lg">é€²å…¥æˆ¿é–“</button>
    </section>

    <section id="config-panel" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
        <div class="glass-card p-8 rounded-[2.5rem] w-full max-w-sm space-y-6">
            <h2 id="config-title" class="text-2xl font-black text-blue-400">éŠæˆ²è¨­å®š</h2>
            
            <div id="bingo-config" class="hidden space-y-2">
                <label class="text-xs font-bold text-slate-400">å¹¾æ¢ç·šç²å‹ï¼Ÿ</label>
                <input type="number" id="winLines" value="3" class="w-full bg-slate-900 p-4 rounded-xl">
            </div>
            
            <div id="spy-config" class="hidden space-y-2">
                <label class="text-xs font-bold text-slate-400">å€’æ•¸è¨ˆæ™‚ (ç§’)ï¼Ÿ</label>
                <input type="number" id="spyTime" value="60" class="w-full bg-slate-900 p-4 rounded-xl">
            </div>

            <div id="draw-config" class="hidden space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-400">ç¸½å›åˆæ•¸</label>
                    <input type="number" id="rounds" value="3" class="w-full bg-slate-900 p-4 rounded-xl">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-400">ä¸€äººæœ€é•·çŒœé¡Œæ™‚é–“ (ç§’)</label>
                    <input type="number" id="drawLimit" value="180" class="w-full bg-slate-900 p-4 rounded-xl">
                </div>
            </div>

            <button onclick="finalStart()" class="w-full bg-orange-500 p-4 rounded-2xl font-black">é–‹å§‹é€£ç·šéŠæˆ²</button>
        </div>
    </section>

    <section id="lobby-zone" class="hidden max-w-md mx-auto space-y-4">
        <div class="glass-card p-6 rounded-[2.5rem] space-y-4">
            <div class="flex justify-between font-black">
                <span id="display-room">æˆ¿è™Ÿï¼š----</span>
                <span id="score-display" class="text-orange-400">å¾—åˆ†ï¼š0</span>
            </div>
            <div id="player-list" class="flex flex-wrap gap-2 text-xs"></div>
            
            <div id="host-controls" class="hidden pt-4 border-t border-slate-700">
                <select id="gameType" class="w-full bg-slate-900 p-4 rounded-2xl font-bold mb-4">
                    <option value="bingo">è³“æœæ¨¡å¼</option>
                    <option value="spy">èª°æ˜¯è‡¥åº•</option>
                    <option value="draw">ä½ ç•«æˆ‘çŒœ</option>
                </select>
                <button onclick="askConfig()" class="w-full bg-blue-600 p-4 rounded-2xl font-black">ä¸‹ä¸€æ­¥ï¼šè¨­å®šåƒæ•¸</button>
            </div>
        </div>

        <div class="glass-card p-4 rounded-[2rem] space-y-4">
            <div id="chat-content" class="h-32 overflow-y-auto text-sm space-y-1"></div>
            <div class="flex gap-2">
                <input type="text" id="answer-input" placeholder="åœ¨é€™è£¡è¼¸å…¥ç­”æ¡ˆ..." class="flex-1 bg-slate-800 p-3 rounded-xl outline-none">
                <button onclick="submitGuess()" class="bg-blue-600 px-6 rounded-xl font-bold">é€å‡º</button>
            </div>
        </div>
    </section>

    <section id="draw-zone" class="hidden max-w-md mx-auto mt-4">
        <div class="glass-card p-4 rounded-[2.5rem] space-y-4">
            <div id="draw-header" class="text-center font-black text-xl text-blue-400">æº–å‚™ä¸­...</div>
            <canvas id="canvas" width="350" height="350" class="w-full"></canvas>
            <div id="word-setter" class="hidden flex gap-2">
                <input type="text" id="custom-word" placeholder="è¼¸å…¥ä½ æƒ³è®“å¤§å®¶çŒœçš„è©" class="flex-1 bg-slate-800 p-3 rounded-xl">
                <button onclick="setWord()" class="bg-orange-500 px-4 rounded-xl font-bold">å‡ºé¡Œ</button>
            </div>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoom, myName, isHost = false, currentMode;

        // --- é€²å…¥æµç¨‹ ---
        function showAction(type) {
            currentMode = type;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('action-panel').classList.remove('hidden');
            document.getElementById('roomIdInput').classList.toggle('hidden', type === 'create');
            document.getElementById('confirm-btn').onclick = type === 'create' ? () => socket.emit('create_room') : joinRoom;
        }

        socket.on('room_created', data => { myRoom = data.roomId; joinRoom(); });

        function joinRoom() {
            myName = document.getElementById('username').value;
            const rid = currentMode === 'create' ? myRoom : document.getElementById('roomIdInput').value;
            if(!myName || !rid) return alert("è³‡è¨Šä¸å®Œæ•´");
            myRoom = rid;
            socket.emit('join_room', { roomId: rid, username: myName });
            document.getElementById('action-panel').classList.add('hidden');
            document.getElementById('lobby-zone').classList.remove('hidden');
            document.getElementById('display-room').innerText = "æˆ¿è™Ÿï¼š" + rid;
        }

        socket.on('room_update', data => {
            isHost = (socket.id === data.hostId);
            document.getElementById('host-controls').classList.toggle('hidden', !isHost);
            document.getElementById('player-list').innerHTML = data.players.map(p => 
                `<span class="bg-slate-800 px-2 py-1 rounded border border-slate-700">${p.id === data.hostId ? 'ğŸ‘‘' : ''}${p.name}</span>`
            ).join('');
        });

        // --- åƒæ•¸è¨­å®šé‚è¼¯ ---
        function askConfig() {
            const game = document.getElementById('gameType').value;
            document.getElementById('config-panel').classList.remove('hidden');
            document.getElementById('bingo-config').classList.toggle('hidden', game !== 'bingo');
            document.getElementById('spy-config').classList.toggle('hidden', game !== 'spy');
            document.getElementById('draw-config').classList.toggle('hidden', game !== 'draw');
        }

        function finalStart() {
            const gameType = document.getElementById('gameType').value;
            const config = {
                winLines: document.getElementById('winLines').value,
                spyTime: document.getElementById('spyTime').value,
                rounds: document.getElementById('rounds').value,
                drawLimit: document.getElementById('drawLimit').value
            };
            socket.emit('start_game_with_config', { roomId: myRoom, gameType, config });
            document.getElementById('config-panel').classList.add('hidden');
        }

        // --- ä½ ç•«æˆ‘çŒœæ ¸å¿ƒé‚è¼¯ ---
        socket.on('draw_turn_start', data => {
            document.getElementById('draw-zone').classList.remove('hidden');
            const isDrawer = (socket.id === data.drawerId);
            document.getElementById('draw-header').innerText = isDrawer ? "ä½ æ˜¯ç•«å®¶ï¼Œè«‹å‡ºé¡Œï¼" : `ç•«å®¶ ${data.drawerName} æ­£åœ¨å‡ºé¡Œ...`;
            document.getElementById('word-setter').classList.toggle('hidden', !isDrawer);
            initCanvas(isDrawer);
        });

        function setWord() {
            const word = document.getElementById('custom-word').value;
            if(!word) return;
            socket.emit('set_draw_word', { roomId: myRoom, word });
            document.getElementById('word-setter').classList.add('hidden');
            document.getElementById('draw-header').innerText = "é¡Œç›®ï¼š" + word;
        }

        function submitGuess() {
            const val = document.getElementById('answer-input').value;
            socket.emit('submit_guess', { roomId: myRoom, username: myName, guess: val });
            document.getElementById('answer-input').value = "";
        }

        socket.on('guess_correct', data => {
            alert(`ğŸ‰ ${data.winner} çŒœå°äº†ï¼(ç­”æ¡ˆï¼š${data.word}) ç²å¾— ${data.points} åˆ†ï¼`);
            document.getElementById('score-display').innerText = "å¾—åˆ†ï¼š" + (data.scores[myName] || 0);
        });

        // --- ç•«å¸ƒé‚è¼¯ (ç°¡æ˜“ç‰ˆ) ---
        let ctx, drawing = false;
        function initCanvas(canDraw) {
            const cvs = document.getElementById('canvas'); ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,350,350);
            cvs.onmousedown = (e) => { if(!canDraw) return; drawing=true; ctx.beginPath(); };
            cvs.onmousemove = (e) => {
                if(!drawing || !canDraw) return;
                const r = cvs.getBoundingClientRect();
                const x = (e.clientX - r.left) * (350/r.width);
                const y = (e.clientY - r.top) * (350/r.height);
                ctx.lineTo(x, y); ctx.stroke();
                socket.emit('drawing', { roomId: myRoom, x, y, type:'line' });
            };
            cvs.onmouseup = () => drawing=false;
        }
        socket.on('drawing', d => { if(d.type==='line'){ ctx.lineTo(d.x, d.y); ctx.stroke(); } });
        
        socket.on('receive_chat', d => {
            const box = document.getElementById('chat-content');
            box.innerHTML += `<div><b>${d.user}:</b> ${d.text}</div>`;
            box.scrollTop = box.scrollHeight;
        });
    </script>
</body>
</html>
