<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PartyBox Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background: #020617; color: white; font-family: sans-serif; overflow: hidden; }
        .view { display: none; min-height: 100vh; flex-direction: column; padding: 1.5rem; }
        .active { display: flex; }
        .glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); }
    </style>
</head>
<body>

    <section id="v-pin" class="view active items-center justify-center">
        <h1 class="text-6xl font-black mb-10 italic text-cyan-500">PartyBox</h1>
        <input id="i-pin" type="text" maxlength="4" placeholder="PIN" class="w-full max-w-xs bg-white/5 p-5 rounded-3xl text-center text-4xl outline-none border border-white/10 focus:border-cyan-500 transition">
        <button onclick="doCheck()" class="w-full max-w-xs mt-6 bg-cyan-600 p-5 rounded-3xl font-bold">é€²å…¥</button>
    </section>

    <section id="v-setup" class="view items-center justify-center">
        <div class="w-full max-w-sm glass p-8 rounded-[3rem] text-center">
            <h2 class="text-2xl font-bold mb-6">è¨­å®šè§’è‰²</h2>
            <div class="grid grid-cols-4 gap-2 mb-6">
                <button onclick="selAv('ğŸ¶', this)" class="av-btn p-3 text-2xl border-2 border-transparent rounded-xl">ğŸ¶</button>
                <button onclick="selAv('ğŸ±', this)" class="av-btn p-3 text-2xl border-2 border-transparent rounded-xl">ğŸ±</button>
                <button onclick="selAv('ğŸ¦Š', this)" class="av-btn p-3 text-2xl border-2 border-transparent rounded-xl">ğŸ¦Š</button>
                <button onclick="selAv('ğŸ·', this)" class="av-btn p-3 text-2xl border-2 border-transparent rounded-xl">ğŸ·</button>
            </div>
            <input id="i-name" type="text" placeholder="æš±ç¨±" class="w-full bg-white/5 p-4 rounded-xl text-center mb-6 outline-none border border-white/10">
            <button onclick="doSave()" class="w-full bg-cyan-500 p-4 rounded-xl font-bold">ç¢ºèª</button>
        </div>
    </section>

    <section id="v-lobby" class="view">
        <div class="flex justify-between items-center mb-6">
            <span id="u-display" class="font-bold"></span>
            <button onclick="localStorage.clear(); location.reload();" class="text-xs text-slate-500">ç™»å‡º</button>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="socket.emit('create_room', myUser)" class="glass p-6 rounded-3xl text-center border-t border-cyan-500/30">å»ºç«‹æˆ¿é–“</button>
            <div class="glass p-2 rounded-3xl">
                <input id="i-rid" type="text" placeholder="æˆ¿è™Ÿ" class="w-full bg-transparent p-2 text-center outline-none">
                <button onclick="doJoin()" class="w-full bg-blue-600 py-2 rounded-xl text-xs font-bold">åŠ å…¥</button>
            </div>
        </div>
        <div class="glass flex-1 rounded-3xl p-6 overflow-y-auto">
            <h3 class="text-center text-xs text-slate-500 mb-4 font-bold tracking-widest">RANKING</h3>
            <div id="leaderboard" class="space-y-2"></div>
        </div>
    </section>

    <section id="v-room" class="view">
        <div class="flex justify-between items-center mb-6">
            <h2 id="r-id-ui" class="text-4xl font-black text-cyan-400 font-mono">----</h2>
            <button onclick="go('v-lobby')" class="text-slate-500">é€€å‡º</button>
        </div>
        <div class="grid grid-cols-1 gap-6 flex-1">
            <div class="glass p-6 rounded-[2rem]">
                <h4 class="text-[10px] text-slate-500 mb-4 font-bold">PLAYER LIST</h4>
                <div id="r-players" class="space-y-2"></div>
            </div>
            <div id="admin-panel" class="hidden glass p-6 rounded-[2rem] border border-yellow-500/20">
                <h4 class="text-[10px] text-yellow-500 mb-4 font-bold uppercase">Admin Console</h4>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="socket.emit('start_game','MEMORY')" class="bg-white/5 p-3 rounded-xl text-xs border border-white/5">ğŸ§  è¨˜æ†¶å¡ç‰Œ</button>
                    <button onclick="socket.emit('start_game','SPY')" class="bg-white/5 p-3 rounded-xl text-xs border border-white/5">ğŸ•µï¸ èª°æ˜¯è‡¥åº•</button>
                </div>
            </div>
            <div id="guest-hint" class="text-center text-slate-500 italic text-sm py-10">ç­‰å¾…æˆ¿ä¸»å•Ÿå‹•éŠæˆ²...</div>
        </div>
    </section>

    <script>
        const socket = io();
        let myUser, myPin, myAv='ğŸ¶';

        // é‡æ–°æ•´ç†è‡ªå‹•ç™»å…¥
        window.onload = () => {
            const saved = localStorage.getItem('party_pin');
            if (saved) socket.emit('check_pin', saved);
            else go('v-pin');
        };

        function go(id) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function selAv(av, el) { myAv=av; document.querySelectorAll('.av-btn').forEach(b=>b.classList.remove('border-cyan-500')); el.classList.add('border-cyan-500'); }
        
        function doCheck() { myPin=document.getElementById('i-pin').value; if(myPin) { localStorage.setItem('party_pin', myPin); socket.emit('check_pin', myPin); } }
        function doSave() { const n=document.getElementById('i-name').value; if(n) socket.emit('save_profile', {pin:myPin, username:n, avatar:myAv}); }
        function doJoin() { const r=document.getElementById('i-rid').value; if(r) socket.emit('join_room', {roomId:r, user:myUser}); }

        socket.on('pin_result', res => { if(res.exists) socket.emit('save_profile', res.user); else go('v-setup'); });
        socket.on('auth_success', u => { myUser=u; document.getElementById('u-display').innerText=`${u.avatar} ${u.username}`; go('v-lobby'); });

        socket.on('room_sync', data => {
            go('v-room');
            document.getElementById('r-id-ui').innerText = data.room.id;
            document.getElementById('r-players').innerHTML = data.room.players.map(p => `
                <div class="flex items-center gap-3 bg-white/5 p-3 rounded-2xl border border-white/5">
                    <span>${p.avatar}</span><span class="font-bold flex-1">${p.username}</span>
                    ${p.pin === data.hostPin ? '<span class="text-[8px] bg-yellow-600 px-2 rounded-full">ADMIN</span>' : ''}
                </div>`).join('');
            
            // æ¬Šé™åˆ¤å®š
            if(myUser.pin === data.hostPin) {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('guest-hint').classList.add('hidden');
            }
        });

        socket.on('rank_update', list => {
            document.getElementById('leaderboard').innerHTML = list.map((p,i)=>`
                <div class="flex justify-between p-3 bg-white/5 rounded-xl text-sm">
                    <span class="text-slate-500">#${i+1} ${p.username}</span><span class="text-cyan-400">${p.score} pt</span>
                </div>`).join('');
        });

        socket.on('room_created', rid => socket.emit('join_room', {roomId: rid, user: myUser}));
        socket.on('goto_game', data => alert('éŠæˆ²é–‹å§‹ï¼š' + data.type));
    </script>
</body>
</html>
