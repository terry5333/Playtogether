<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .chat-box { height: 120px; overflow-y: auto; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-6">

    <header class="text-center py-10" id="header-logo">
        <h1 class="text-5xl font-black tracking-tighter">PARTY<span class="text-blue-500">BOX.</span></h1>
    </header>

    <main id="main-menu" class="max-w-md mx-auto space-y-4">
        <div onclick="showAction('create')" class="glass-card p-8 rounded-[2.5rem] cursor-pointer hover:scale-105 transition border-l-8 border-blue-500">
            <h2 class="text-2xl font-black">å‰µå»ºæˆ¿é–“</h2>
            <p class="text-slate-400 text-sm mt-1">é–‹å•Ÿä¸€å€‹æ–°æˆ¿é–“ä¸¦æˆç‚ºæˆ¿ä¸»</p>
        </div>
        <div onclick="showAction('join')" class="glass-card p-8 rounded-[2.5rem] cursor-pointer hover:scale-105 transition border-l-8 border-orange-500">
            <h2 class="text-2xl font-black">åŠ å…¥æˆ¿é–“</h2>
            <p class="text-slate-400 text-sm mt-1">è¼¸å…¥æˆ¿è™Ÿï¼Œé€²å…¥å¥½å‹çš„æˆ¿é–“</p>
        </div>
    </main>

    <section id="action-panel" class="hidden max-w-md mx-auto space-y-4">
        <input type="text" id="username" placeholder="ä½ çš„æš±ç¨±" class="w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-blue-500 transition">
        <div id="join-field" class="hidden">
            <input type="text" id="roomIdInput" placeholder="4 ä½æ•¸æˆ¿è™Ÿ" class="w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-orange-500 transition">
        </div>
        <button id="confirm-btn" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-lg shadow-xl shadow-blue-900/40">ç¢ºèªé€²å…¥</button>
        <button onclick="location.reload()" class="w-full text-slate-500 font-bold text-sm">è¿”å›ä¸»é¸å–®</button>
    </section>

    <section id="lobby-zone" class="hidden max-w-md mx-auto space-y-4">
        <div class="glass-card p-6 rounded-[2.5rem] space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black">æˆ¿è™Ÿï¼š<span id="display-room" class="text-blue-500">----</span></h2>
                <div class="bg-slate-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest" id="player-count">0 Players</div>
            </div>

            <div id="player-list" class="flex flex-wrap gap-2 py-2"></div>

            <div id="host-controls" class="hidden border-t border-slate-700 pt-6 space-y-4">
                <select id="gameType" class="w-full bg-slate-900 p-4 rounded-2xl font-bold outline-none border border-slate-700">
                    <option value="bingo">è³“æœé€£é€£çœ‹</option>
                    <option value="spy">èª°æ˜¯è‡¥åº•</option>
                </select>
                <button onclick="sendStart()" class="w-full bg-orange-500 p-4 rounded-2xl font-black text-lg shadow-xl shadow-orange-900/30">é–‹å§‹éŠæˆ²</button>
            </div>
            
            <div id="wait-msg" class="text-center text-slate-500 py-4 font-bold animate-pulse">ç­‰å¾…æˆ¿ä¸»é–‹å§‹...</div>
        </div>

        <div class="glass-card p-5 rounded-[2.5rem] space-y-4">
            <div id="chat-content" class="chat-box space-y-2 p-2 rounded-xl text-sm"></div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="èªªé»ä»€éº¼..." class="flex-1 bg-slate-800 p-3 rounded-xl outline-none text-xs">
                <button onclick="sendChat()" class="bg-blue-600 px-4 rounded-xl font-black text-xs">ç™¼é€</button>
            </div>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoom = "", myName = "", currentAction = "";

        function showAction(type) {
            currentAction = type;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('action-panel').classList.remove('hidden');
            document.getElementById('join-field').classList.toggle('hidden', type === 'create');
            document.getElementById('confirm-btn').onclick = type === 'create' ? createRoom : joinRoom;
        }

        function createRoom() { socket.emit('create_room'); }
        socket.on('room_created', (data) => {
            myRoom = data.roomId;
            joinRoom();
        });

        function joinRoom() {
            myName = document.getElementById('username').value;
            const rid = currentAction === 'create' ? myRoom : document.getElementById('roomIdInput').value;
            if(!myName || !rid) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            myRoom = rid;
            socket.emit('join_room', { roomId: rid, username: myName });
            
            document.getElementById('action-panel').classList.add('hidden');
            document.getElementById('header-logo').classList.add('hidden');
            document.getElementById('lobby-zone').classList.remove('hidden');
            document.getElementById('display-room').innerText = rid;
        }

        socket.on('room_update', (data) => {
            document.getElementById('player-count').innerText = `${data.players.length} Players`;
            
            // æ›´æ–°ç©å®¶æ¨™ç±¤
            const list = document.getElementById('player-list');
            list.innerHTML = data.players.map(p => `
                <div class="bg-slate-800 px-4 py-2 rounded-xl border border-slate-700 text-xs font-bold">
                    ${p.id === data.hostId ? 'ğŸ‘‘ ' : ''}${p.name}
                </div>
            `).join('');

            // æˆ¿ä¸»æŒ‰éˆ•é¡¯ç¤ºåˆ¤å®š
            const isHost = socket.id === data.hostId;
            document.getElementById('host-controls').classList.toggle('hidden', !isHost);
            document.getElementById('wait-msg').classList.toggle('hidden', isHost);
        });

        // èŠå¤©ç³»çµ±
        function sendChat() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            socket.emit('send_chat', { roomId: myRoom, user: myName, text: input.value });
            input.value = "";
        }

        socket.on('receive_chat', (data) => {
            const content = document.getElementById('chat-content');
            content.innerHTML += `
                <div class="mb-2">
                    <span class="text-blue-400 font-black text-[10px] uppercase">${data.user}</span>
                    <span class="text-slate-600 text-[9px] ml-1">${data.time}</span>
                    <p class="text-slate-300 mt-0.5">${data.text}</p>
                </div>
            `;
            content.scrollTop = content.scrollHeight;
        });

        function sendStart() {
            const type = document.getElementById('gameType').value;
            socket.emit('start_game', { roomId: myRoom, gameType: type });
        }

        socket.on('game_begin', (data) => {
            alert("éŠæˆ²é–‹å§‹ï¼š" + data.gameType);
            // è½‰å ´è‡³å°æ‡‰éŠæˆ² UI é‚è¼¯
        });

        socket.on('error_msg', (msg) => alert(msg));
    </script>
</body>
</html>
