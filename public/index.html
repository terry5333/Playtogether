<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Party Box</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .bingo-cell { aspect-ratio: 1/1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 12px; transition: 0.2s; border: 2px solid #f1f5f9; }
        .cell-filled { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }
        .cell-marked { background: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }
        canvas { touch-action: none; background: #fff; border-radius: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-800 font-sans">

    <div id="lobby" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-6">
            <h1 class="text-5xl font-black text-center text-slate-900 tracking-tighter mb-10">PARTY<br><span class="text-blue-600">BOX.</span></h1>
            <input type="text" id="username" placeholder="你的暱稱" class="w-full p-4 rounded-3xl border-none shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
            <input type="text" id="roomId" placeholder="輸入房號" class="w-full p-4 rounded-3xl border-none shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
            <button onclick="join()" class="w-full bg-slate-900 text-white p-4 rounded-3xl font-bold shadow-xl active:scale-95 transition">加入房間</button>
        </div>
    </div>

    <div id="game-area" class="hidden min-h-screen p-4 flex flex-col items-center">
        
        <div id="host-panel" class="hidden w-full max-w-sm bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 mb-6">
            <h2 class="text-center font-black text-slate-400 text-xs uppercase tracking-widest mb-4">Game Settings</h2>
            <select id="gameType" onchange="toggleSettings()" class="w-full p-3 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700">
                <option value="bingo">賓果連連看</option>
                <option value="draw">你畫我猜</option>
                <option value="spy">誰是臥底</option>
            </select>
            <div id="spy-config" class="hidden mt-4">
                <label class="text-xs font-bold text-slate-400">倒數秒數</label>
                <input type="number" id="spyTime" value="60" class="w-full p-3 bg-slate-50 rounded-2xl mt-1">
            </div>
            <button onclick="startGame()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold mt-4 shadow-lg shadow-blue-100">開始遊戲</button>
        </div>

        <div id="ui-bingo" class="hidden w-full max-w-sm space-y-4">
            <div id="bingo-hint" class="text-center font-bold text-blue-500 bg-blue-50 py-2 rounded-full text-sm">請依序填入 1-25</div>
            <div id="bingo-grid" class="grid grid-cols-5 gap-2 bg-white p-3 rounded-[2rem] shadow-xl"></div>
        </div>

        <div id="ui-draw" class="hidden w-full max-w-sm space-y-4 text-center">
            <p id="draw-info" class="font-black text-xl text-slate-700">準備猜題...</p>
            <canvas id="canvas" width="400" height="400" class="w-full"></canvas>
            <div id="guess-area" class="flex gap-2">
                <input type="text" id="guess-input" placeholder="輸入答案" class="flex-1 p-3 rounded-2xl border-none shadow-inner bg-slate-100">
                <button onclick="submitGuess()" class="bg-slate-900 text-white px-6 rounded-2xl font-bold">送出</button>
            </div>
        </div>

        <div id="ui-spy" class="hidden w-full max-w-sm space-y-6">
            <div id="timer-box" class="text-center text-3xl font-black text-red-500">60s</div>
            <div onclick="toggleSpy()" class="h-64 bg-white rounded-[3rem] shadow-2xl flex flex-col items-center justify-center border-b-[12px] border-blue-500 active:scale-95 transition-all">
                <p class="text-[10px] font-bold text-slate-300 uppercase mb-2">點擊查看身分</p>
                <span id="spy-word" class="text-4xl font-black text-slate-800">？ ？ ？</span>
            </div>
            <div id="vote-list" class="hidden grid grid-cols-2 gap-2"></div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curRoom, myName, isHost = false, fillIdx = 1, board = Array(25).fill(0), myWord = "";

        function join() {
            myName = document.getElementById('username').value;
            curRoom = document.getElementById('roomId').value;
            if(!myName || !curRoom) return alert("填寫完整");
            socket.emit('join_room', { roomId: curRoom, username: myName });
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
        }

        socket.on('room_update', (room) => {
            isHost = (socket.id === room.host);
            if(isHost && !room.gameStarted) document.getElementById('host-panel').classList.remove('hidden');
        });

        function startGame() {
            const type = document.getElementById('gameType').value;
            const settings = { spyTime: document.getElementById('spyTime').value };
            socket.emit('start_game', { roomId: curRoom, gameType: type, settings });
            document.getElementById('host-panel').classList.add('hidden');
        }

        socket.on('game_begin', (data) => {
            document.querySelectorAll('[id^="ui-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`ui-${data.gameType}`).classList.remove('hidden');
            if(data.gameType === 'bingo') initBingo();
            if(data.gameType === 'draw') initDraw();
        });

        // 賓果邏輯：手動填號
        function initBingo() {
            const grid = document.getElementById('bingo-grid'); grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = "bingo-cell bg-slate-50";
                cell.onclick = () => {
                    if(fillIdx <= 25) {
                        if(board[i]) return;
                        board[i] = fillIdx; cell.innerText = fillIdx; cell.classList.add('cell-filled'); fillIdx++;
                    } else {
                        socket.emit('bingo_click', { roomId: curRoom, num: board[i] });
                    }
                };
                grid.appendChild(cell);
            }
        }
        socket.on('bingo_sync', (num) => {
            const idx = board.indexOf(num);
            if(idx !== -1) document.getElementById('bingo-grid').children[idx].classList.add('cell-marked');
        });

        // 誰是臥底邏輯
        socket.on('spy_setup', (data) => { myWord = data.word; });
        function toggleSpy() { const el = document.getElementById('spy-word'); el.innerText = el.innerText === "？ ？ ？" ? myWord : "？ ？ ？"; }
        socket.on('timer_sync', (s) => document.getElementById('timer-box').innerText = s + "s");
        socket.on('spy_force_vote', () => {
            document.getElementById('vote-list').classList.remove('hidden');
            alert("描述時間到！開始投票");
        });

        // 你畫我猜畫布 (修正坐標)
        let ctx, drawing = false;
        function initDraw() {
            const cvs = document.getElementById('canvas'); ctx = cvs.getContext('2d');
            cvs.onmousedown = () => { drawing = true; ctx.beginPath(); };
            cvs.onmousemove = (e) => {
                if(!drawing) return;
                const r = cvs.getBoundingClientRect();
                const x = (e.clientX - r.left) * (400/r.width);
                const y = (e.clientY - r.top) * (400/r.height);
                ctx.lineTo(x, y); ctx.stroke();
                socket.emit('drawing', { roomId: curRoom, x, y, type:'line' });
            };
            cvs.onmouseup = () => drawing = false;
        }
        socket.on('drawing', (d) => { if(d.type==='line'){ ctx.lineTo(d.x, d.y); ctx.stroke(); } });
    </script>
</body>
</html>
