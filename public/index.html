<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PartyBox Pro Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; }
        .view { display: none; min-height: 100vh; padding: 1.5rem; flex-direction: column; }
        .view.active { display: flex; }
        .glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .btn-cyan { background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); }
    </style>
</head>
<body>

    <section id="v-pin" class="view active items-center justify-center">
        <h1 class="text-6xl font-black mb-8 italic text-cyan-400">PartyBox</h1>
        <input id="i-pin" type="text" placeholder="4ä½ PIN" class="w-64 bg-white/5 p-5 rounded-3xl text-center text-3xl border-2 border-transparent focus:border-cyan-500 outline-none transition">
        <button onclick="doCheck()" class="w-64 mt-6 btn-cyan p-5 rounded-3xl font-bold text-xl">é–‹å§‹</button>
    </section>

    <section id="v-setup" class="view items-center justify-center">
        <div class="w-full max-w-sm glass p-8 rounded-[3rem] text-center">
            <h2 class="text-2xl font-bold mb-8">è¨­å®šä½ çš„è§’è‰²</h2>
            <input id="i-name" type="text" placeholder="æš±ç¨±" class="w-full bg-white/5 p-4 rounded-2xl text-center mb-8 outline-none border border-white/10">
            <button onclick="doSave()" class="w-full btn-cyan p-4 rounded-2xl font-black">é€²å…¥å¤§å»³</button>
        </div>
    </section>

    <section id="v-lobby" class="view">
        <div class="flex justify-between items-center mb-6">
            <div id="u-display" class="font-bold text-lg"></div>
            <div id="u-score" class="text-cyan-400">Score: 0</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1">
            <div class="glass p-8 rounded-[2.5rem] flex flex-col items-center">
                <h3 class="text-xl font-bold mb-6 text-cyan-400">å»ºç«‹æˆ¿é–“</h3>
                <div class="space-y-4 w-full">
                    <button onclick="socket.emit('create_room')" class="w-full bg-white/5 border border-white/10 p-6 rounded-3xl text-lg hover:bg-white/10 transition">
                        âœ¨ å»ºç«‹æ–°æ´¾å°æˆ¿
                    </button>
                    <p class="text-xs text-slate-500 text-center italic">å»ºç«‹å¾Œå¯é¸æ“‡ èª°æ˜¯è‡¥åº•ã€Bingoã€è¨˜æ†¶å¡ç‰Œ æˆ– ä½ è©±æˆ‘çŒœ</p>
                </div>
            </div>

            <div class="glass p-8 rounded-[2.5rem] flex flex-col items-center">
                <h3 class="text-xl font-bold mb-6 text-blue-400">åŠ å…¥æˆ¿é–“</h3>
                <input id="i-rid" type="text" placeholder="è¼¸å…¥ 4 ä½æˆ¿è™Ÿ" class="w-full bg-white/5 p-6 rounded-3xl text-center text-2xl mb-4 border border-white/10">
                <button onclick="doJoin()" class="w-full bg-blue-600 p-5 rounded-3xl font-bold">åŠ å…¥</button>
            </div>
        </div>

        <div class="mt-8 glass p-6 rounded-[2rem]">
            <h3 class="text-center text-sm font-bold tracking-widest text-slate-500 mb-4 uppercase">ğŸ† å…¨æœç©åˆ†æ’è¡Œæ¦œ</h3>
            <div id="leaderboard" class="space-y-2">
                </div>
        </div>
    </section>

    <section id="v-play" class="view items-center">
        <div id="g-header" class="text-center mb-4">
            <h2 id="g-title" class="text-2xl font-bold text-cyan-400"></h2>
            <p id="g-info" class="text-sm text-slate-400"></p>
        </div>
        <div id="g-ui" class="flex-1 w-full glass rounded-[3rem] p-6 flex items-center justify-center"></div>
        <button onclick="go('v-lobby')" class="mt-4 text-slate-600 font-bold py-4">è¿”å›å¤§å»³</button>
    </section>

    <script>
        const socket = io();
        let myUser, myPin, memoryCards=[], flipped=[];

        function go(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // ç™»å…¥é‚è¼¯
        function doCheck() {
            myPin = document.getElementById('i-pin').value;
            if(myPin.length === 4) socket.emit('check_pin', myPin);
        }

        socket.on('pin_result', res => {
            if(res.exists) socket.emit('save_profile', res.user);
            else go('v-setup');
        });

        function doSave() {
            const name = document.getElementById('i-name').value;
            if(name) socket.emit('save_profile', { pin: myPin, username: name, avatar: 'ğŸ‘¤' });
        }

        socket.on('auth_success', u => {
            myUser = u;
            document.getElementById('u-display').innerText = u.username;
            document.getElementById('u-score').innerText = `Score: ${u.score}`;
            go('v-lobby');
        });

        // åŠ å…¥æˆ¿é–“
        function doJoin() {
            const rid = document.getElementById('i-rid').value;
            if(rid) socket.emit('join_room', { roomId: rid, user: myUser });
        }

        // æ’è¡Œæ¦œæ›´æ–°
        socket.on('update_leaderboard', list => {
            const container = document.getElementById('leaderboard');
            container.innerHTML = list.map((p, i) => `
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/5">
                    <span class="font-bold text-slate-400">#${i+1} ${p.username}</span>
                    <span class="text-cyan-400 font-mono font-bold">${p.score} pt</span>
                </div>
            `).join('');
        });

        // è¨˜æ†¶å¡ç‰ŒéŠæˆ²ç¯„ä¾‹ (ç²å‹æœƒè§¸ç™¼ç©åˆ†)
        socket.on('game_init', data => {
            go('v-play');
            const ui = document.getElementById('g-ui');
            if(data.type === 'MEMORY') {
                document.getElementById('g-title').innerText = "è¨˜æ†¶å¡ç‰Œ";
                ui.className = "flex-1 w-full glass rounded-[3rem] grid grid-cols-4 gap-2 p-6";
                memoryCards = data.cards;
                memoryCards.forEach((icon, i) => {
                    ui.innerHTML += `<button id="c-${i}" onclick="socket.emit('flip_card', ${i})" class="h-20 bg-white/10 rounded-2xl text-2xl flex items-center justify-center">?</button>`;
                });
            }
        });

        socket.on('on_flip', idx => {
            const btn = document.getElementById(`c-${idx}`);
            btn.innerText = memoryCards[idx];
            btn.classList.add('bg-cyan-500/50');
            flipped.push(idx);
            if(flipped.length === 2) {
                const [a, b] = flipped;
                if(memoryCards[a] === memoryCards[b]) {
                    setTimeout(() => {
                        document.getElementById(`c-${a}`).style.opacity = '0.3';
                        document.getElementById(`c-${b}`).style.opacity = '0.3';
                        flipped=[];
                        // ç°¡å–®æª¢æŸ¥æ˜¯å¦å…¨å°
                        if(document.querySelectorAll('button[style*="opacity: 0.3"]').length === memoryCards.length) {
                            socket.emit('game_win', { points: 20 });
                        }
                    }, 500);
                } else {
                    setTimeout(() => {
                        document.getElementById(`c-${a}`).innerText='?'; 
                        document.getElementById(`c-${b}`).innerText='?';
                        document.getElementById(`c-${a}`).classList.remove('bg-cyan-500/50');
                        document.getElementById(`c-${b}`).classList.remove('bg-cyan-500/50');
                        flipped=[];
                    }, 800);
                }
            }
        });

        socket.on('game_over', data => {
            document.getElementById('g-info').innerText = `ğŸ‰ éŠæˆ²çµæŸï¼è´å®¶ï¼š${data.winner}`;
        });

        socket.on('room_created', rid => {
            document.getElementById('i-rid').value = rid;
            doJoin();
        });
    </script>
</body>
</html>
