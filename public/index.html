<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX æ——è‰¦æ•´åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        canvas { background: white; border-radius: 1.5rem; touch-action: none; cursor: crosshair; }
        .bingo-cell { aspect-ratio: 1/1; background: #1e293b; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        .marked { background: #ef4444 !important; color: white; }
    </style>
</head>
<body class="p-4">

    <main id="main-menu" class="max-w-md mx-auto space-y-4 pt-20">
        <h1 class="text-5xl font-black text-center mb-10 tracking-tighter italic">PARTY<span class="text-blue-500">BOX.</span></h1>
        <div onclick="showAction('create')" class="glass p-8 rounded-[2rem] cursor-pointer hover:bg-slate-800 transition border-l-8 border-blue-500">
            <h2 class="text-2xl font-black text-white">å‰µå»ºæˆ¿é–“</h2>
            <p class="text-slate-400 text-sm">èº«ç‚ºæˆ¿ä¸»é–‹å•Ÿæ–°å±€</p>
        </div>
        <div onclick="showAction('join')" class="glass p-8 rounded-[2rem] cursor-pointer hover:bg-slate-800 transition border-l-8 border-orange-500">
            <h2 class="text-2xl font-black text-white">åŠ å…¥æˆ¿é–“</h2>
            <p class="text-slate-400 text-sm">è¼¸å…¥æˆ¿è™Ÿç«‹å³é€£ç·š</p>
        </div>
    </main>

    <section id="action-panel" class="hidden max-w-md mx-auto space-y-4 pt-20">
        <input type="text" id="username" placeholder="è¼¸å…¥æš±ç¨±" class="w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-blue-500">
        <input type="text" id="roomIdInput" placeholder="è¼¸å…¥ 4 ä½æ•¸æˆ¿è™Ÿ" class="hidden w-full bg-slate-800 p-4 rounded-2xl outline-none ring-2 ring-transparent focus:ring-orange-500">
        <button id="confirm-btn" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-lg shadow-xl">é€²å…¥å¤§å»³</button>
        <button onclick="location.reload()" class="w-full text-slate-500 font-bold">è¿”å›</button>
    </section>

    <section id="lobby-zone" class="hidden max-w-md mx-auto space-y-4">
        <div class="glass p-6 rounded-[2.5rem] space-y-6">
            <div class="flex justify-between items-center font-black">
                <span id="room-id-tag" class="text-blue-500 text-xl">æˆ¿è™Ÿï¼š----</span>
                <span id="score-tag" class="text-orange-400">å¾—åˆ†ï¼š0</span>
            </div>
            <div id="player-list" class="flex flex-wrap gap-2 justify-center"></div>

            <div id="host-controls" class="hidden border-t border-slate-700 pt-6 space-y-3">
                <p class="text-center text-[10px] font-black uppercase text-slate-500 tracking-widest">æˆ¿ä¸»è«‹é¸æ“‡æ¨¡å¼</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="openConfig('bingo')" class="bg-slate-800 p-4 rounded-2xl font-bold hover:bg-slate-700 border-l-4 border-blue-500">è³“æœé€£é€£çœ‹</button>
                    <button onclick="openConfig('spy')" class="bg-slate-800 p-4 rounded-2xl font-bold hover:bg-slate-700 border-l-4 border-green-500">èª°æ˜¯è‡¥åº•</button>
                    <button onclick="openConfig('draw')" class="bg-slate-800 p-4 rounded-2xl font-bold hover:bg-slate-700 border-l-4 border-orange-500">ä½ ç•«æˆ‘çŒœ</button>
                </div>
            </div>
            <p id="wait-msg" class="text-center text-slate-500 animate-pulse py-4 font-bold">ç­‰å¾…æˆ¿ä¸»é¸æ“‡æ¨¡å¼...</p>
        </div>

        <div class="glass p-5 rounded-[2.5rem] space-y-4">
            <div id="chat-content" class="h-32 overflow-y-auto text-sm space-y-1 p-2"></div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="åœ¨é€™è£¡èŠå¤©æˆ–è¼¸å…¥ç­”æ¡ˆ..." class="flex-1 bg-slate-800 p-3 rounded-xl outline-none text-xs">
                <button onclick="sendChat()" class="bg-blue-600 px-4 rounded-xl font-black text-xs">ç™¼é€</button>
            </div>
        </div>
    </section>

    <section id="config-modal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="glass p-8 rounded-[3rem] w-full max-w-sm space-y-6">
            <h2 id="config-title" class="text-2xl font-black text-center">è¨­å®šåƒæ•¸</h2>
            <div id="opt-bingo" class="hidden"><label class="text-xs text-slate-400">å¹¾æ¢ç·šç²å‹ï¼Ÿ</label><input type="number" id="winLines" value="3" class="w-full bg-slate-900 p-4 rounded-2xl mt-1"></div>
            <div id="opt-spy" class="hidden"><label class="text-xs text-slate-400">è¨è«–æ™‚é–“(ç§’)</label><input type="number" id="spyTime" value="60" class="w-full bg-slate-900 p-4 rounded-2xl mt-1"></div>
            <div id="opt-draw" class="hidden space-y-4">
                <div><label class="text-xs text-slate-400">ç¸½å›åˆæ•¸</label><input type="number" id="rounds" value="3" class="w-full bg-slate-900 p-4 rounded-2xl mt-1"></div>
                <div><label class="text-xs text-slate-400">é™æ™‚(ç§’)</label><input type="number" id="drawLimit" value="180" class="w-full bg-slate-900 p-4 rounded-2xl mt-1"></div>
            </div>
            <button onclick="confirmStart()" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-lg">ç¢ºå®šä¸¦é–‹å§‹</button>
            <button onclick="closeConfig()" class="w-full text-slate-500 text-xs">å–æ¶ˆ</button>
        </div>
    </section>

    <section id="game-zone" class="hidden max-w-md mx-auto space-y-4">
        <div class="glass p-6 rounded-[2.5rem]">
            <div id="bingo-view" class="hidden space-y-4">
                <p id="bingo-hint" class="text-center text-blue-400 font-bold">è«‹å¡«å…¥ 1-25</p>
                <div id="bingo-grid" class="grid grid-cols-5 gap-2"></div>
            </div>
            <div id="draw-view" class="hidden space-y-4">
                <p id="draw-header" class="text-center font-black text-blue-400">æº–å‚™ä¸­...</p>
                <canvas id="canvas" width="350" height="350" class="w-full"></canvas>
                <div id="word-setter" class="hidden flex gap-2">
                    <input type="text" id="custom-word" placeholder="è¼¸å…¥è©å½™" class="flex-1 bg-slate-800 p-3 rounded-xl outline-none">
                    <button onclick="setWord()" class="bg-orange-500 px-4 rounded-xl font-bold">å‡ºé¡Œ</button>
                </div>
            </div>
            <div id="spy-view" class="hidden space-y-6 text-center">
                <div onclick="this.innerHTML=myWord" class="h-48 glass rounded-[2rem] flex items-center justify-center text-xl font-black cursor-pointer border-2 border-dashed border-slate-600">é»æ“Šçœ‹è©</div>
            </div>
            <button onclick="location.reload()" class="w-full mt-6 text-slate-600 text-[10px] font-bold">çµ‚æ­¢éŠæˆ²</button>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoom, myName, isHost, currentAction, selectedGame, myWord, fillIdx=1, myBoard=Array(25).fill(0);

        function showAction(type) {
            currentAction = type;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('action-panel').classList.remove('hidden');
            document.getElementById('roomIdInput').classList.toggle('hidden', type==='create');
            document.getElementById('confirm-btn').onclick = type==='create' ? () => socket.emit('create_room') : joinRoom;
        }

        socket.on('room_created', d => { myRoom = d.roomId; joinRoom(); });
        function joinRoom() {
            myName = document.getElementById('username').value;
            const rid = currentAction === 'create' ? myRoom : document.getElementById('roomIdInput').value;
            if(!myName || !rid) return;
            myRoom = rid;
            socket.emit('join_room', { roomId: rid, username: myName });
            document.getElementById('action-panel').classList.add('hidden');
            document.getElementById('header-logo')?.classList.add('hidden');
            document.getElementById('lobby-zone').classList.remove('hidden');
            document.getElementById('room-id-tag').innerText = "æˆ¿è™Ÿï¼š" + rid;
        }

        socket.on('room_update', d => {
            isHost = socket.id === d.hostId;
            document.getElementById('host-controls').classList.toggle('hidden', !isHost);
            document.getElementById('wait-msg').classList.toggle('hidden', isHost);
            document.getElementById('player-list').innerHTML = d.players.map(p => `<span class="bg-slate-800 px-3 py-1 rounded-xl text-[10px] border border-slate-700">${p.id===d.hostId?'ğŸ‘‘':''}${p.name}</span>`).join('');
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            socket.emit('send_chat', { roomId: myRoom, user: myName, text: input.value });
            input.value = "";
        }
        socket.on('receive_chat', d => {
            const box = document.getElementById('chat-content');
            box.innerHTML += `<div><b class="text-blue-400">${d.user}:</b> <span class="text-slate-300">${d.text}</span></div>`;
            box.scrollTop = box.scrollHeight;
        });

        // åƒæ•¸è©¢å•è‘‰é¢é‚è¼¯
        function openConfig(type) {
            selectedGame = type;
            document.getElementById('config-modal').classList.remove('hidden');
            ['bingo','spy','draw'].forEach(g => document.getElementById('opt-'+g).classList.add('hidden'));
            document.getElementById('opt-'+type).classList.remove('hidden');
        }
        function closeConfig() { document.getElementById('config-modal').classList.add('hidden'); }
        function confirmStart() {
            const config = { winLines: document.getElementById('winLines').value, spyTime: document.getElementById('spyTime').value, rounds: document.getElementById('rounds').value, drawLimit: document.getElementById('drawLimit').value };
            socket.emit('start_game_with_config', { roomId: myRoom, gameType: selectedGame, config });
            closeConfig();
        }

        // éŠæˆ²è½‰å ´é‚è¼¯
        socket.on('game_begin', d => {
            document.getElementById('lobby-zone').classList.add('hidden');
            document.getElementById('game-zone').classList.remove('hidden');
            document.getElementById('bingo-view').classList.toggle('hidden', d.gameType !== 'bingo');
            document.getElementById('spy-view').classList.toggle('hidden', d.gameType !== 'spy');
            if(d.gameType === 'bingo') initBingo();
            if(d.gameType === 'spy') myWord = d.word;
        });

        // ä½ ç•«æˆ‘çŒœç‰¹æ®Šè½‰å ´
        socket.on('draw_turn_start', d => {
            document.getElementById('lobby-zone').classList.add('hidden');
            document.getElementById('game-zone').classList.remove('hidden');
            document.getElementById('draw-view').classList.remove('hidden');
            const drawer = (socket.id === d.drawerId);
            document.getElementById('draw-header').innerText = drawer ? "ä½ æ˜¯ç•«å®¶ï¼Œè«‹å‡ºé¡Œ" : `ç•«å®¶ ${d.drawerName} æ­£åœ¨å‡ºé¡Œ...`;
            document.getElementById('word-setter').classList.toggle('hidden', !drawer);
            initCanvas(drawer);
        });

        function setWord() {
            const w = document.getElementById('custom-word').value;
            socket.emit('set_draw_word', { roomId: myRoom, word: w });
            document.getElementById('word-setter').classList.add('hidden');
            document.getElementById('draw-header').innerText = "é¡Œç›®ï¼š" + w;
        }

        socket.on('guess_correct', d => {
            alert(`ğŸ‰ ${d.winner} çŒœå°äº† (ç­”æ¡ˆ: ${d.word})ï¼ç²å¾— ${d.pts} åˆ†`);
            document.getElementById('score-tag').innerText = "å¾—åˆ†ï¼š" + (d.scores[myName] || 0);
        });

        // ç•«å¸ƒèˆ‡ Bingo é‚è¼¯ (åŒå‰ï¼Œå·²æ•´åˆè‡³ initCanvas/initBingo)
        let ctx, drawing=false;
        function initCanvas(can) {
            const cvs = document.getElementById('canvas'); ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,350,350); ctx.strokeStyle = "black"; ctx.lineWidth = 3;
            cvs.onmousedown = (e) => { if(!can) return; drawing=true; ctx.beginPath(); };
            cvs.onmousemove = (e) => {
                if(!drawing || !can) return;
                const r = cvs.getBoundingClientRect();
                const x = (e.clientX - r.left) * (350/r.width);
                const y = (e.clientY - r.top) * (350/r.height);
                ctx.lineTo(x, y); ctx.stroke();
                socket.emit('drawing', { roomId: myRoom, x, y, type: 'line' });
            };
            cvs.onmouseup = () => drawing=false;
        }
        socket.on('drawing', d => { if(d.type==='line'){ ctx.lineTo(d.x, d.y); ctx.stroke(); } });

        function initBingo() {
            const g = document.getElementById('bingo-grid'); g.innerHTML = "";
            for(let i=0; i<25; i++) {
                const c = document.createElement('div'); c.className = "bingo-cell";
                c.onclick = () => {
                    if(fillIdx <= 25) { if(myBoard[i]) return; myBoard[i]=fillIdx; c.innerText=fillIdx; c.style.color="#3b82f6"; fillIdx++; }
                    else { socket.emit('bingo_click', { roomId: myRoom, num: myBoard[i] }); }
                };
                g.appendChild(c);
            }
        }
        socket.on('bingo_sync', n => {
            const idx = myBoard.indexOf(n);
            if(idx !== -1) document.getElementById('bingo-grid').children[idx].classList.add('marked');
        });
    </script>
</body>
</html>
