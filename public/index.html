<script>
    let gameStarted = false; // 關鍵：確保預設為 false
    let bingoLayout = Array(25).fill(null);
    let markedCells = Array(25).fill(false);
    let winTarget = 3;

    function initBingo() {
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = '';
        for(let i=0; i<25; i++) {
            const b = document.createElement('div');
            b.className = "bingo-cell text-lg";
            b.id = `cell-${i}`;
            b.onclick = () => {
                // 模式 1：遊戲未開始 -> 填入號碼
                if (!gameStarted) {
                    if (!bingoLayout[i] && fillCount <= 25) {
                        bingoLayout[i] = fillCount;
                        b.innerText = fillCount;
                        b.classList.add('bg-blue-50', 'text-blue-500');
                        fillCount++;
                    }
                } 
                // 模式 2：遊戲已開始 -> 點擊選號 (必須是自己的回合)
                else if (isMyTurn && bingoLayout[i] && !markedCells[i]) {
                    socket.emit('bingo_click', { roomId: curRoom, num: bingoLayout[i] });
                }
            };
            grid.appendChild(b);
        }
    }

    // 隨機填號功能
    function autoFill() {
        if (gameStarted) return;
        const nums = Array.from({length: 25}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        nums.forEach((n, i) => {
            bingoLayout[i] = n;
            const c = document.getElementById(`cell-${i}`);
            c.innerText = n;
            c.className = "bingo-cell text-lg bg-blue-50 text-blue-500";
        });
        fillCount = 26;
    }

    // 接收遊戲開始指令
    socket.on('game_begin', (d) => {
        gameStarted = true; // 強制切換為點擊模式
        winTarget = d.winLines;
        updateTurn(d.turnId, d.turnName);
        document.getElementById('status-tag').innerText = "遊戲開始！";
    });

    // 接收同步號碼
    socket.on('bingo_sync', (num) => {
        const idx = bingoLayout.indexOf(num);
        if (idx !== -1) {
            markedCells[idx] = true;
            document.getElementById(`cell-${idx}`).classList.add('bg-[#2F4F4F]', 'text-white');
            checkWin();
        }
    });

    function checkWin() {
        let lines = 0;
        const m = markedCells;
        // 橫
        for(let i=0; i<25; i+=5) if(m[i]&&m[i+1]&&m[i+2]&&m[i+3]&&m[i+4]) lines++;
        // 直
        for(let i=0; i<5; i++) if(m[i]&&m[i+5]&&m[i+10]&&m[i+15]&&m[i+20]) lines++;
        // 斜
        if(m[0]&&m[6]&&m[12]&&m[18]&&m[24]) lines++;
        if(m[4]&&m[8]&&m[12]&&m[16]&&m[20]) lines++;

        if(lines >= winTarget) {
            socket.emit('bingo_win', { roomId: curRoom, name: myName });
        }
    }
</script>
